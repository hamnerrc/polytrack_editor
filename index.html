<!DOCTYPE html>

<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PolyTrack Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ THEMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-theme="dark"]{
Â Â --bg:#08090f; --surf:#0d1019; --panel:#121622; --card:#161c2d;
Â Â --b1:#1e2840; --b2:#2a3a58;
Â Â --txt:#c4d0ee; --bright:#eef2ff; --dim:#4e6080; --faint:#1a2236;
Â Â --acc:#f5a623; --alo:rgba(245,166,35,.1); --abd:rgba(245,166,35,.25);
Â Â --cyan:#39c8e0; --grn:#3dd68c; --red:#e04040;
Â Â --cbg:#000; --cclr:#39c8e0;
Â Â --glow:rgba(245,166,35,.18); --shad:rgba(0,0,0,.6);
Â Â --scan:rgba(0,0,0,.045);
}
[data-theme="light"]{
Â Â --bg:#f0f2f8; --surf:#ffffff; --panel:#f7f8fc; --card:#ffffff;
Â Â --b1:#dde2ef; --b2:#c4cce0;
Â Â --txt:#2a3350; --bright:#111830; --dim:#7080a0; --faint:#e8ebf5;
Â Â --acc:#c87c08; --alo:rgba(200,124,8,.09); --abd:rgba(200,124,8,.22);
Â Â --cyan:#1899b8; --grn:#1d9e5e; --red:#c03030;
Â Â --cbg:#1a1e2e; --cclr:#5dcfe8;
Â Â --glow:rgba(200,124,8,.12); --shad:rgba(0,0,0,.15);
Â Â --scan:rgba(0,0,0,0);
}

/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
font-family:â€˜Rajdhaniâ€™,sans-serif;
background:var(â€“bg);color:var(â€“txt);
min-height:100vh;overflow-x:hidden;transition:background .2s,color .2s;
}
[data-theme=â€œdarkâ€] body::before{
content:â€™â€™;position:fixed;inset:0;pointer-events:none;z-index:9999;
background:repeating-linear-gradient(0deg,transparent,transparent 2px,var(â€“scan) 2px,var(â€“scan) 4px);
}

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{
display:flex;align-items:center;justify-content:space-between;
height:50px;padding:0 1.4rem;
background:var(â€“surf);border-bottom:1px solid var(â€“b1);
position:sticky;top:0;z-index:300;
}
.logo{display:flex;align-items:center;gap:.6rem}
.logo-gem{
width:24px;height:24px;background:var(â€“acc);flex-shrink:0;
clip-path:polygon(50% 0%,100% 38%,82% 100%,18% 100%,0% 38%);
box-shadow:0 0 12px var(â€“glow);
}
.logo-txt{font-size:1rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(â€“bright)}
.logo-txt span{color:var(â€“acc)}
.topbar-r{display:flex;align-items:center;gap:.75rem}
#topInfo{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.55rem;color:var(â€“dim);letter-spacing:1px}
.theme-toggle{
width:30px;height:30px;border-radius:50%;
border:1px solid var(â€“b1);background:var(â€“panel);
cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;
transition:all .15s;color:var(â€“txt);
}
.theme-toggle:hover{border-color:var(â€“acc);color:var(â€“acc)}

/* â”€â”€ MODE TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{
display:flex;background:var(â€“surf);
border-bottom:2px solid var(â€“b1);padding:0 1.4rem;
}
.tab{
padding:.65rem 1.2rem;font-weight:700;font-size:.68rem;
letter-spacing:2px;text-transform:uppercase;color:var(â€“dim);
cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;
transition:color .15s;display:flex;align-items:center;gap:.4rem;white-space:nowrap;
}
.tab:hover{color:var(â€“txt)}
.tab.on{color:var(â€“acc);border-bottom-color:var(â€“acc)}
.pill{
font-size:.5rem;padding:.1rem .3rem;border-radius:2px;
background:var(â€“alo);border:1px solid var(â€“abd);color:var(â€“acc);
}

/* â”€â”€ WORKSPACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.workspace{display:grid;grid-template-columns:296px 1fr;min-height:calc(100vh - 98px)}
.sidebar{background:var(â€“surf);border-right:1px solid var(â€“b1);overflow-y:auto;display:flex;flex-direction:column}
.main{display:flex;flex-direction:column;min-height:0}

/* â”€â”€ SIDEBAR STEP SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.step{padding:.9rem 1.1rem;border-bottom:1px solid var(â€“b1)}
.step:last-child{border-bottom:none;flex:1}
.step-hd{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem}
.step-num{
width:19px;height:19px;border-radius:50%;flex-shrink:0;
background:var(â€“alo);border:1px solid var(â€“abd);
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.58rem;font-weight:700;
color:var(â€“acc);display:flex;align-items:center;justify-content:center;
}
.step-lbl{font-size:.6rem;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(â€“dim)}

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field{margin-bottom:.6rem}.field:last-child{margin-bottom:0}
.field>label{
display:block;font-size:.58rem;font-weight:600;letter-spacing:1.8px;
text-transform:uppercase;color:var(â€“dim);margin-bottom:.25rem;
}
input[type=text],input[type=number],select,textarea{
width:100%;padding:.42rem .58rem;
background:var(â€“panel);border:1px solid var(â€“b1);border-radius:3px;
color:var(â€“txt);font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.76rem;
outline:none;transition:border-color .15s,box-shadow .15s;
}
input:focus,select:focus,textarea:focus{border-color:var(â€“acc);box-shadow:0 0 0 2px rgba(245,166,35,.1)}
select option{background:var(â€“panel);color:var(â€“txt)}
textarea{resize:vertical;min-height:85px;line-height:1.5}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:.3rem}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.3rem}
.chk{display:flex;align-items:center;gap:.4rem;font-size:.74rem;color:var(â€“txt);cursor:pointer;margin-top:.28rem}
.chk input[type=checkbox]{accent-color:var(â€“acc);width:12px;height:12px;flex-shrink:0}
.tog-row{display:flex;align-items:center;justify-content:space-between;padding:.38rem 0;border-bottom:1px solid var(â€“b1)}
.tog-row:last-child{border-bottom:none}
.tog-row label{font-size:.74rem;color:var(â€“txt);cursor:pointer}
.tog-row input[type=checkbox]{accent-color:var(â€“acc)}
.muted-note{font-size:.62rem;color:var(â€“dim);margin-top:.3rem;line-height:1.5}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
display:inline-flex;align-items:center;justify-content:center;gap:.3rem;
padding:.42rem .75rem;border:none;border-radius:3px;cursor:pointer;
font-family:â€˜Rajdhaniâ€™,sans-serif;font-weight:700;font-size:.7rem;
letter-spacing:1.5px;text-transform:uppercase;transition:all .15s;
}
.btn-acc{background:var(â€“acc);color:#000;box-shadow:0 0 14px var(â€“glow)}
.btn-acc:hover{filter:brightness(1.12);box-shadow:0 0 22px var(â€“glow)}
.btn-acc:active{transform:scale(.97)}
.btn-acc:disabled{background:var(â€“faint);color:var(â€“dim);box-shadow:none;cursor:not-allowed}
.btn-ghost{background:transparent;color:var(â€“dim);border:1px solid var(â€“b1)}
.btn-ghost:hover{color:var(â€“txt);border-color:var(â€“b2)}
.btn-del{background:transparent;color:var(â€“red);border:1px solid rgba(224,64,64,.2)}
.btn-del:hover{background:rgba(224,64,64,.06)}
.btn-sm{padding:.24rem .48rem;font-size:.6rem}
.btn-full{width:100%}
.btn-row{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.5rem}
/* big CTA with shimmer */
.cta{
width:100%;padding:.72rem;font-size:.78rem;letter-spacing:2px;
margin-top:.55rem;position:relative;overflow:hidden;
}
.cta::after{
content:â€™â€™;position:absolute;inset:0;pointer-events:none;
background:linear-gradient(90deg,transparent,rgba(255,255,255,.14),transparent);
transform:translateX(-100%);transition:transform .45s;
}
.cta:not(:disabled):hover::after{transform:translateX(100%)}

/* â”€â”€ STATS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-bar{display:flex;background:var(â€“b1);gap:1px;border-bottom:1px solid var(â€“b1);flex-shrink:0}
.stat{background:var(â€“surf);padding:.6rem .9rem;flex:1;display:flex;flex-direction:column;gap:.12rem}
.sv{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:1.05rem;font-weight:700;color:var(â€“acc);line-height:1}
.sl{font-size:.52rem;color:var(â€“dim);letter-spacing:1.5px;text-transform:uppercase}

/* â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{flex:1;overflow-y:auto;padding:1.1rem;display:flex;flex-direction:column;gap:.9rem}

/* â”€â”€ PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel{background:var(â€“panel);border:1px solid var(â€“b1);border-radius:4px;overflow:hidden}
.ph{padding:.58rem .85rem;border-bottom:1px solid var(â€“b1);display:flex;align-items:center;justify-content:space-between}
.pt{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.58rem;letter-spacing:2px;color:var(â€“dim);text-transform:uppercase}
.pb{padding:.8rem .85rem}
.pf{padding:.5rem .85rem;border-top:1px solid var(â€“b1);display:flex;gap:.35rem;align-items:center}

/* â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cvs-wrap{background:var(â€“panel);border:1px solid var(â€“b1);border-radius:4px;position:relative;overflow:hidden}
.cvs-wrap canvas{display:block;width:100%}
.cvs-info{position:absolute;top:.55rem;right:.7rem;font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.55rem;color:var(â€“dim);letter-spacing:1px}

/* â”€â”€ CODE BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.code-box{
background:var(â€“cbg);padding:.75rem .85rem;
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.66rem;
word-break:break-all;max-height:110px;overflow:auto;
color:var(â€“cclr);line-height:1.65;letter-spacing:.3px;
}
.log-txt{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.62rem;color:var(â€“dim)}
.log-txt .ok{color:var(â€“grn)}.log-txt .warn{color:var(â€“acc)}.log-txt .err{color:var(â€“red)}
#debugLog{background:var(â€“cbg);padding:.6rem .85rem;font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.6rem;color:var(â€“dim);line-height:1.9;max-height:170px;overflow-y:auto}

/* â”€â”€ DROP ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drop-zone{
border:2px dashed var(â€“b1);border-radius:3px;padding:1rem;text-align:center;
cursor:pointer;transition:all .15s;font-size:.7rem;color:var(â€“dim);position:relative;margin-top:.45rem;
}
.drop-zone.over{border-color:var(â€“acc);background:var(â€“alo);color:var(â€“acc)}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}

/* â”€â”€ LINES LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lines-list{max-height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:.28rem}
.li{display:flex;align-items:center;gap:.5rem;background:var(â€“card);border:1px solid var(â€“b1);border-radius:3px;padding:.42rem .65rem;transition:border-color .12s}
.li:hover{border-color:var(â€“b2)}
.id-badge{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.56rem;font-weight:700;background:var(â€“alo);color:var(â€“acc);border:1px solid var(â€“abd);padding:.1rem .35rem;border-radius:2px;min-width:36px;text-align:center;flex-shrink:0}
.li-info{flex:1;min-width:0}
.li-name{font-size:.56rem;color:var(â€“acc);margin-bottom:.06rem}
.li-meta{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.6rem;color:var(â€“txt)}
.li-coords{font-size:.53rem;color:var(â€“dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.empty-st{text-align:center;padding:1.75rem .5rem;color:var(â€“dim)}
.empty-st div{font-size:1.8rem;opacity:.16;margin-bottom:.35rem}
.empty-st p{font-size:.7rem;line-height:1.6}

/* â”€â”€ INFO BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info{background:var(â€“alo);border:1px solid var(â€“abd);border-left:3px solid var(â€“acc);border-radius:3px;padding:.5rem .75rem;font-size:.68rem;color:var(â€“dim);line-height:1.7;margin-bottom:.5rem}
.info b{color:var(â€“acc)}

/* â”€â”€ PIXEL ART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.px-grid{display:grid;grid-template-columns:1fr 270px;gap:.9rem}
.px-preview{background:var(â€“panel);border:1px solid var(â€“b1);border-radius:4px;overflow:hidden}
.px-preview canvas{display:block;width:100%}
.map-row{display:flex;align-items:center;gap:.45rem;padding:.32rem 0;border-bottom:1px solid var(â€“b1)}
.map-row:last-child{border-bottom:none}
.swatch{width:13px;height:13px;border-radius:2px;flex-shrink:0}
.map-row span{font-size:.66rem;color:var(â€“dim);flex:1}
.map-row input{width:54px!important;text-align:center;padding:.28rem .35rem!important;font-size:.72rem!important}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{
position:fixed;bottom:1.4rem;right:1.4rem;z-index:10000;pointer-events:none;
background:var(â€“panel);border:1px solid var(â€“acc);border-radius:4px;
padding:.55rem .95rem;font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.68rem;
color:var(â€“acc);letter-spacing:1px;
box-shadow:0 8px 30px var(â€“shad),0 0 16px var(â€“glow);
transform:translateY(60px);opacity:0;transition:all .24s cubic-bezier(.34,1.56,.64,1);
}
.toast.show{transform:translateY(0);opacity:1}

/* â”€â”€ DISABLED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.greyed{opacity:.38;pointer-events:none}

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(â€“faint);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(â€“dim)}

@media(max-width:860px){
.workspace{grid-template-columns:1fr}
.sidebar{border-right:none;border-bottom:1px solid var(â€“b1)}
.px-grid{grid-template-columns:1fr}
}
</style>

</head>
<body>

<!-- TOPBAR -->

<div class="topbar">
Â Â <div class="logo">
Â Â Â Â <div class="logo-gem"></div>
Â Â Â Â <div class="logo-txt">Poly<span>Track</span> Studio</div>
Â Â </div>
Â Â <div class="topbar-r">
Â Â Â Â <div id="topInfo">SELECT A MODE TO BEGIN</div>
Â Â Â Â <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()" title="Toggle light / dark">ğŸŒ™</button>
Â Â </div>
</div>

<!-- MODE TABS -->

<div class="tabs">
Â Â <div class="tab on" id="tab-kml" onclick="switchMode('kml')">ğŸ—º KML Circuit <span class="pill">1:1 SCALE</span></div>
Â Â <div class="tab" id="tab-shape" onclick="switchMode('shape')">â—ˆ Shape Builder</div>
Â Â <div class="tab" id="tab-pixel" onclick="switchMode('pixel')">ğŸ¨ Pixel Art</div>
</div>

<!-- WORKSPACE -->

<div class="workspace">
<div class="sidebar">

<!-- â•â•â•â• KML SIDEBAR â•â•â•â• -->

<div id="sb-kml">

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">1</div><div class="step-lbl">Load your KML path</div></div>
Â Â Â Â <div class="info">
Â Â Â Â Â Â In <b>Google Earth</b>, draw a path along a road, then <b>right-click â†’ Save Place As â†’ KML</b>.<br>
Â Â Â Â Â Â <b>1 block = 20 Ã— 20 m</b> â€” exact real-world scale.
Â Â Â Â </div>
Â Â Â Â <div class="field">
Â Â Â Â Â Â <label>Paste KML content</label>
Â Â Â Â Â Â <textarea id="kmlInput" placeholder="&lt;?xml version=&quot;1.0&quot; ...&#10;Paste the full KML file text here." spellcheck="false"></textarea>
Â Â Â Â </div>
Â Â Â Â <div class="drop-zone" id="dropZone">
Â Â Â Â Â Â <input type="file" id="fileInput" accept=".kml,.xml">
Â Â Â Â Â Â <div style="font-size:1.15rem;margin-bottom:.2rem">ğŸ“‚</div>
Â Â Â Â Â Â <div>Or drop a .kml file here</div>
Â Â Â Â </div>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">2</div><div class="step-lbl">Road settings</div></div>
Â Â Â Â <div class="g2">
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Origin X (blocks)</label><input type="number" id="originX" value="500"></div>
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Origin Z (blocks)</label><input type="number" id="originZ" value="500"></div>
Â Â Â Â </div>
Â Â Â Â <div class="g2" style="margin-top:.4rem">
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Base height Y</label><input type="number" id="originY" value="0"></div>
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Road width (blocks)</label><input type="number" id="roadWidth" value="1" min="1" max="10"></div>
Â Â Â Â </div>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">3</div><div class="step-lbl">Path options</div></div>
Â Â Â Â <div class="tog-row">
Â Â Â Â Â Â <label for="smoothPath">Smooth path (RDP algorithm)</label>
Â Â Â Â Â Â <input type="checkbox" id="smoothPath" checked>
Â Â Â Â </div>
Â Â Â Â <div class="field" style="margin-top:.5rem">
Â Â Â Â Â Â <label>Smoothing tolerance (metres)</label>
Â Â Â Â Â Â <input type="number" id="smoothTol" value="10" min="1" max="200">
Â Â Â Â </div>
Â Â Â Â <div class="field">
Â Â Â Â Â Â <label>Checkpoint turn angle (degrees)</label>
Â Â Â Â Â Â <input type="number" id="turnAngle" value="20" min="5" max="90">
Â Â Â Â </div>
Â Â Â Â <div class="tog-row">
Â Â Â Â Â Â <label for="useElevation">Use real elevation (Y axis)</label>
Â Â Â Â Â Â <input type="checkbox" id="useElevation">
Â Â Â Â </div>
Â Â Â Â <div class="muted-note" id="elevNote" style="display:none">Uses hill blocks (ID 145/146) on slopes. Each ramp = 40 m horizontal, 10 m rise. Slopes are snapped to nearest ramp increment.</div>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">4</div><div class="step-lbl">Name &amp; generate</div></div>
Â Â Â Â <div class="field"><label>Track name</label><input type="text" id="kmlTrackName" value="My Circuit" maxlength="50"></div>
Â Â Â Â <div class="field"><label>Author</label><input type="text" id="kmlAuthor" value="Builder" maxlength="50"></div>
Â Â Â Â <button class="btn btn-acc cta" id="kmlBtn" onclick="generateKML()">âš¡ Generate Circuit Code</button>
Â Â </div>

</div><!-- /sb-kml -->

<!-- â•â•â•â• SHAPE SIDEBAR â•â•â•â• -->

<div id="sb-shape" style="display:none">

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">1</div><div class="step-lbl">Add a shape</div></div>
Â Â Â Â <div class="field">
Â Â Â Â Â Â <label>Shape type</label>
Â Â Â Â Â Â <select id="shapeType">
Â Â Â Â Â Â Â Â <option value="line">Line â€” point A to point B</option>
Â Â Â Â Â Â Â Â <option value="filledRect">Filled Rectangle â€” flat plane</option>
Â Â Â Â Â Â Â Â <option value="hollowCube">Hollow Cube â€” walls only</option>
Â Â Â Â Â Â Â Â <option value="filledCube">Filled Cube â€” solid volume</option>
Â Â Â Â Â Â </select>
Â Â Â Â </div>

```
<div id="form-line" class="sf">
Â Â <div class="field"><label>Block ID</label><input type="number" id="lineId" value="25" min="0" max="255"></div>
Â Â <div class="field"><label>Start â€” X Â· Y Â· Z</label>
Â Â Â Â <div class="g3"><input type="number" id="lsx" value="0"><input type="number" id="lsy" value="0"><input type="number" id="lsz" value="0"></div>
Â Â </div>
Â Â <div class="field"><label>End â€” X Â· Y Â· Z</label>
Â Â Â Â <div class="g3"><input type="number" id="lex" value="100"><input type="number" id="ley" value="0"><input type="number" id="lez" value="0"></div>
Â Â </div>
Â Â <div class="field"><label>Rotation (0â€“3)</label><input type="number" id="lineRot" value="0" min="0" max="3"></div>
</div>

<div id="form-filledRect" class="sf" style="display:none">
Â Â <div class="field"><label>Plane orientation</label>
Â Â Â Â <select id="rectPlane">
Â Â Â Â Â Â <option value="xz">XZ â€” horizontal (floor / ceiling)</option>
Â Â Â Â Â Â <option value="xy">XY â€” vertical (front / back wall)</option>
Â Â Â Â Â Â <option value="yz">YZ â€” vertical (left / right wall)</option>
Â Â Â Â </select>
Â Â </div>
Â Â <div class="field"><label id="fixedLabel">Fixed Y</label><input type="number" id="fixedCoord" value="0"></div>
Â Â <div class="g2">
Â Â Â Â <div class="field" style="margin:0"><label id="min1Label">Min X</label><input type="number" id="rectMin1" value="0"></div>
Â Â Â Â <div class="field" style="margin:0"><label id="max1Label">Max X</label><input type="number" id="rectMax1" value="100"></div>
Â Â </div>
Â Â <div class="g2" style="margin-top:.35rem">
Â Â Â Â <div class="field" style="margin:0"><label id="min2Label">Min Z</label><input type="number" id="rectMin2" value="0"></div>
Â Â Â Â <div class="field" style="margin:0"><label id="max2Label">Max Z</label><input type="number" id="rectMax2" value="100"></div>
Â Â </div>
Â Â <div class="g2" style="margin-top:.35rem">
Â Â Â Â <div class="field" style="margin:0"><label>Block ID</label><input type="number" id="rectId" value="25"></div>
Â Â Â Â <div class="field" style="margin:0"><label>Rotation</label><input type="number" id="rectRot" value="0" min="0" max="3"></div>
Â Â </div>
</div>

<div id="form-hollowCube" class="sf" style="display:none">
Â Â <div class="field"><label>Min corner â€” X Â· Y Â· Z</label>
Â Â Â Â <div class="g3"><input type="number" id="hcMinX" value="0"><input type="number" id="hcMinY" value="0"><input type="number" id="hcMinZ" value="0"></div>
Â Â </div>
Â Â <div class="field"><label>Max corner â€” X Â· Y Â· Z</label>
Â Â Â Â <div class="g3"><input type="number" id="hcMaxX" value="100"><input type="number" id="hcMaxY" value="100"><input type="number" id="hcMaxZ" value="100"></div>
Â Â </div>
Â Â <div class="g2" style="margin-top:.35rem">
Â Â Â Â <div class="field" style="margin:0"><label>Block ID</label><input type="number" id="hcId" value="25"></div>
Â Â Â Â <div class="field" style="margin:0"><label>Rotation</label><input type="number" id="hcRot" value="0" min="0" max="3"></div>
Â Â </div>
</div>

<div id="form-filledCube" class="sf" style="display:none">
Â Â <div class="field"><label>Min corner â€” X Â· Y Â· Z</label>
Â Â Â Â <div class="g3"><input type="number" id="fcMinX" value="0"><input type="number" id="fcMinY" value="0"><input type="number" id="fcMinZ" value="0"></div>
Â Â </div>
Â Â <div class="field"><label>Max corner â€” X Â· Y Â· Z</label>
Â Â Â Â <div class="g3"><input type="number" id="fcMaxX" value="100"><input type="number" id="fcMaxY" value="100"><input type="number" id="fcMaxZ" value="100"></div>
Â Â </div>
Â Â <div class="g2" style="margin-top:.35rem">
Â Â Â Â <div class="field" style="margin:0"><label>Block ID</label><input type="number" id="fcId" value="25"></div>
Â Â Â Â <div class="field" style="margin:0"><label>Rotation</label><input type="number" id="fcRot" value="0" min="0" max="3"></div>
Â Â </div>
</div>

<button class="btn btn-acc btn-full" onclick="addShape()" style="margin-top:.55rem">+ Add Shape</button>
```

Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">2</div><div class="step-lbl">Review shape list</div></div>
Â Â Â Â <div class="lines-list" id="linesList">
Â Â Â Â Â Â <div class="empty-st"><div>â—ˆ</div><p>No shapes yet.<br>Add shapes above to build your track.</p></div>
Â Â Â Â </div>
Â Â Â Â <div class="btn-row">
Â Â Â Â Â Â <button class="btn btn-ghost btn-sm" onclick="exportJSON()">Export JSON</button>
Â Â Â Â Â Â <button class="btn btn-del btn-sm" onclick="clearLines()">Clear All</button>
Â Â Â Â </div>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">3</div><div class="step-lbl">ID test track (optional)</div></div>
Â Â Â Â <div class="info">Generates one block of every ID in a row â€” useful for seeing what each block type looks like in-game.</div>
Â Â Â Â <div class="g2">
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Min ID</label><input type="number" id="minId" value="1" min="0" max="255"></div>
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Max ID</label><input type="number" id="maxId" value="50" min="0" max="255"></div>
Â Â Â Â </div>
Â Â Â Â <button class="btn btn-ghost btn-full" onclick="generateTestTrack()" style="margin-top:.45rem">Generate ID Test Track</button>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">4</div><div class="step-lbl">Hill inserter</div></div>
Â Â Â Â <div class="info">
Â Â Â Â Â Â Places a symmetric hill using <b>ID 145</b> (0Â°â†’45Â° ramp) automatically rotated to face any direction.<br>
Â Â Â Â Â Â <b>Hill = ramp up + ramp down.</b> Each half is 4 blocks long. Total: 80 m long, 20 m high.
Â Â Â Â </div>

```
<!-- Rotation diagram -->
<div id="hillDiagram" style="margin-bottom:.65rem;background:var(--card);border:1px solid var(--b1);border-radius:4px;padding:.6rem;text-align:center">
Â Â <canvas id="hillCanvas" width="240" height="160" style="display:block;margin:0 auto"></canvas>
Â Â <div style="font-size:.6rem;color:var(--dim);margin-top:.35rem;letter-spacing:1px">ROTATION PREVIEW â€” drag angle or type below</div>
</div>

<div class="field">
Â Â <label>Direction angle (degrees, 0 = +Z, 90 = +X)</label>
Â Â <div style="display:flex;gap:.35rem;align-items:center">
Â Â Â Â <input type="range" id="hillAngle" min="0" max="359" value="0" style="flex:1;accent-color:var(--acc)" oninput="syncHillAngle(this.value)">
Â Â Â Â <input type="number" id="hillAngleTxt" value="0" min="0" max="359" style="width:58px!important;text-align:center" oninput="syncHillAngle(this.value)">
Â Â </div>
</div>

<div class="field"><label>Rotation info</label>
Â Â <div id="hillRotInfo" style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--acc);background:var(--panel);border:1px solid var(--b1);border-radius:3px;padding:.38rem .55rem;line-height:1.7">
Â Â Â Â Up-ramp rot=0 Â· Down-ramp rot=2
Â Â </div>
</div>

<div class="field"><label>Hill base position â€” X Â· Y Â· Z</label>
Â Â <div class="g3">
Â Â Â Â <input type="number" id="hillX" value="0" placeholder="X">
Â Â Â Â <input type="number" id="hillY" value="0" placeholder="Y">
Â Â Â Â <input type="number" id="hillZ" value="0" placeholder="Z">
Â Â </div>
</div>

<div class="field"><label>Width (blocks, default 1)</label>
Â Â <input type="number" id="hillWidth" value="1" min="1" max="20">
</div>

<button class="btn btn-acc btn-full" onclick="addHill()" style="margin-top:.1rem">â›° Add Hill to List</button>
```

Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">5</div><div class="step-lbl">Name &amp; generate</div></div>
Â Â Â Â <div class="field"><label>Track name</label><input type="text" id="shapeTrackName" value="My Track" maxlength="50"></div>
Â Â Â Â <div class="field"><label>Author</label><input type="text" id="shapeAuthor" value="Builder" maxlength="50"></div>
Â Â Â Â <button class="btn btn-acc cta" onclick="generateShape()">âš¡ Generate Track Code</button>
Â Â </div>

</div><!-- /sb-shape -->

<!-- â•â•â•â• PIXEL SIDEBAR â•â•â•â• -->

<div id="sb-pixel" style="display:none">

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">1</div><div class="step-lbl">Upload an image</div></div>
Â Â Â Â <div class="info">The image is converted to <b>3 shades</b> (dark / mid / light). Each pixel becomes one block. High-contrast images work best.</div>
Â Â Â Â <div class="field"><label>Image file (PNG / JPEG / GIF)</label><input type="file" id="imgUpload" accept="image/*"></div>
Â Â Â Â <div class="g2">
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Resolution (longest side)</label><input type="number" id="resValue" value="64" min="8" max="256"></div>
Â Â Â Â Â Â <div class="field" style="margin:0"><label>Spacing (blocks/px)</label><input type="number" id="pixelSpacing" value="1" min="1" max="10"></div>
Â Â Â Â </div>
Â Â Â Â <label class="chk"><input type="checkbox" id="preserveAspect" checked> Preserve aspect ratio</label>
Â Â Â Â <label class="chk"><input type="checkbox" id="use4x" checked> 4Ã— PolyTrack coordinate scale</label>
Â Â Â Â <button class="btn btn-acc btn-full" onclick="processUpload()" style="margin-top:.55rem">Preview Image â†’</button>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">2</div><div class="step-lbl">Assign block IDs to 3 shades</div></div>
Â Â Â Â <div class="map-row">
Â Â Â Â Â Â <div class="swatch" style="background:#1a2eaa"></div>
Â Â Â Â Â Â <span>Dark pixels</span>
Â Â Â Â Â Â <input type="number" id="idBin0" value="5" min="0" max="255">
Â Â Â Â </div>
Â Â Â Â <div class="map-row">
Â Â Â Â Â Â <div class="swatch" style="background:#7a7e96"></div>
Â Â Â Â Â Â <span>Mid pixels</span>
Â Â Â Â Â Â <input type="number" id="idBin1" value="25" min="0" max="255">
Â Â Â Â </div>
Â Â Â Â <div class="map-row">
Â Â Â Â Â Â <div class="swatch" style="background:#d8ddf0"></div>
Â Â Â Â Â Â <span>Light pixels</span>
Â Â Â Â Â Â <input type="number" id="idBin2" value="52" min="0" max="255">
Â Â Â Â </div>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">3</div><div class="step-lbl">Position in world</div></div>
Â Â Â Â <div class="field"><label>Offset â€” X Â· Y Â· Z</label>
Â Â Â Â Â Â <div class="g3">
Â Â Â Â Â Â Â Â <input type="number" id="offsetX" value="0" placeholder="X">
Â Â Â Â Â Â Â Â <input type="number" id="offsetY" value="0" placeholder="Y">
Â Â Â Â Â Â Â Â <input type="number" id="offsetZ" value="0" placeholder="Z">
Â Â Â Â Â Â </div>
Â Â Â Â </div>
Â Â </div>

Â Â <div class="step">
Â Â Â Â <div class="step-hd"><div class="step-num">4</div><div class="step-lbl">Name &amp; generate</div></div>
Â Â Â Â <div class="field"><label>Track name</label><input type="text" id="pixelTrackName" value="Pixel Art" maxlength="50"></div>
Â Â Â Â <div class="field"><label>Author</label><input type="text" id="pixelAuthor" value="Builder" maxlength="50"></div>
Â Â Â Â <button class="btn btn-acc cta" onclick="generatePixel()">âš¡ Generate Pixel Track</button>
Â Â </div>

</div><!-- /sb-pixel -->
</div><!-- /sidebar -->

<!-- â•â•â•â• MAIN PANEL â•â•â•â• -->

<div class="main">

Â Â <div class="stats-bar">
Â Â Â Â <div class="stat"><div class="sv" id="sA">â€”</div><div class="sl" id="slA">â€”</div></div>
Â Â Â Â <div class="stat"><div class="sv" id="sB">â€”</div><div class="sl" id="slB">â€”</div></div>
Â Â Â Â <div class="stat"><div class="sv" id="sC">â€”</div><div class="sl" id="slC">â€”</div></div>
Â Â Â Â <div class="stat"><div class="sv" id="sD">â€”</div><div class="sl" id="slD">â€”</div></div>
Â Â Â Â <div class="stat"><div class="sv" id="sE">â€”</div><div class="sl">Code Size</div></div>
Â Â </div>

Â Â <div class="content">

```
<!-- KML canvas (shown only in kml mode) -->
<div class="cvs-wrap" id="kmlWrap">
Â Â <canvas id="kmlCanvas" height="310"></canvas>
Â Â <div class="cvs-info" id="cvInfo">NO TRACK LOADED</div>
</div>

<!-- Pixel preview (shown only in pixel mode after upload) -->
<div id="pixPanel" style="display:none">
Â Â <div class="px-grid">
Â Â Â Â <div>
Â Â Â Â Â Â <p style="font-size:.58rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:.45rem">COLOUR PREVIEW</p>
Â Â Â Â Â Â <div class="info">These 3 colours represent your 3 block IDs. Adjust the ID numbers in Step 2, then hit Generate.</div>
Â Â Â Â Â Â <div style="display:flex;gap:.5rem;margin-top:.5rem">
Â Â Â Â Â Â Â Â <div class="stat" style="flex:0 0 auto;border:1px solid var(--b1);border-radius:3px;padding:.45rem .75rem">
Â Â Â Â Â Â Â Â Â Â <div class="sv" id="pixCount" style="font-size:.9rem">0</div><div class="sl">Pixels</div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â <div class="stat" style="flex:0 0 auto;border:1px solid var(--b1);border-radius:3px;padding:.45rem .75rem">
Â Â Â Â Â Â Â Â Â Â <div class="sv" id="pixW" style="font-size:.9rem">â€”</div><div class="sl">Width</div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â <div class="stat" style="flex:0 0 auto;border:1px solid var(--b1);border-radius:3px;padding:.45rem .75rem">
Â Â Â Â Â Â Â Â Â Â <div class="sv" id="pixH" style="font-size:.9rem">â€”</div><div class="sl">Height</div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>
Â Â Â Â </div>
Â Â Â Â <div>
Â Â Â Â Â Â <p style="font-size:.58rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:.4rem">PREVIEW</p>
Â Â Â Â Â Â <div class="px-preview"><canvas id="previewCanvas" width="270" height="270"></canvas></div>
Â Â Â Â </div>
Â Â </div>
</div>

<!-- Track code output -->
<div class="panel">
Â Â <div class="ph">
Â Â Â Â <span class="pt">Track Code Output</span>
Â Â Â Â <span class="log-txt" id="logBox"></span>
Â Â </div>
Â Â <div class="code-box" id="outputCode">Generate a track using any mode above â€” the PolyTrack import code will appear here.</div>
Â Â <div class="pf">
Â Â Â Â <button class="btn btn-ghost btn-sm" onclick="copyCode()">ğŸ“‹ Copy</button>
Â Â Â Â <button class="btn btn-ghost btn-sm" onclick="downloadCode()">â¬‡ Download .txt</button>
Â Â </div>
</div>

<!-- Debug console -->
<div class="panel">
Â Â <div class="ph" style="cursor:pointer" onclick="toggleDebug()">
Â Â Â Â <span class="pt">Debug Console</span>
Â Â Â Â <span id="dbgToggle" style="font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--dim)">â–¶ expand</span>
Â Â </div>
Â Â <div id="dbgPanel" style="display:none">
Â Â Â Â <div id="debugLog"></div>
Â Â Â Â <div class="pf"><button class="btn btn-ghost btn-sm" onclick="clearDbg()">Clear</button></div>
Â Â </div>
</div>
```

Â Â </div><!-- /content -->
</div><!-- /main -->
</div><!-- /workspace -->

<div class="toast" id="toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
let gLines=[]; // shared shape builder lines
let gPixels=null; // processed pixel data
let gCode=''; // last generated code
let gMode='kml';

const ID_NAMES={
Â Â 5:'Start (legacy)',6:'Finish (legacy)',
Â Â 25:'Road',52:'Checkpoint',
Â Â 75:'Checkpoint (numbered)',76:'Finish',92:'Start'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme(){
Â Â const html=document.documentElement;
Â Â const isDark=html.getAttribute('data-theme')==='dark';
Â Â html.setAttribute('data-theme',isDark?'light':'dark');
Â Â document.getElementById('themeBtn').textContent=isDark?'ğŸŒ™':'â˜€ï¸';
Â Â localStorage.setItem('pt-theme',isDark?'light':'dark');
Â Â if(gMode==='kml') redrawKML();
}
(()=>{
Â Â const saved=localStorage.getItem('pt-theme');
Â Â if(saved){
Â Â Â Â document.documentElement.setAttribute('data-theme',saved);
Â Â Â Â document.getElementById('themeBtn').textContent=saved==='light'?'ğŸŒ™':'â˜€ï¸';
Â Â }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST / LOG / DEBUG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _tt;
function toast(msg){
Â Â const e=document.getElementById('toast');
Â Â e.textContent=msg;e.classList.add('show');
Â Â clearTimeout(_tt);_tt=setTimeout(()=>e.classList.remove('show'),2300);
}
function log(msg,c=''){document.getElementById('logBox').innerHTML=`<span class="${c}">${msg}</span>`;}
const _dl=[];
function dbg(msg,c=''){
Â Â const ts=new Date().toLocaleTimeString('en',{hour12:false});
Â Â _dl.push({ts,msg,c});if(_dl.length>200)_dl.shift();
Â Â const el=document.getElementById('debugLog');if(!el)return;
Â Â const C={err:'#e04040',warn:'#f5a623',ok:'#3dd68c','':'#3a6060'};
Â Â el.innerHTML=_dl.map(l=>`<div style="color:${C[l.c]||C['']}">[${l.ts}] ${l.msg}</div>`).join('');
Â Â el.scrollTop=el.scrollHeight;
}
function clearDbg(){_dl.length=0;const e=document.getElementById('debugLog');if(e)e.innerHTML='';}
function toggleDebug(){
Â Â const p=document.getElementById('dbgPanel'),t=document.getElementById('dbgToggle');
Â Â const o=p.style.display==='none';p.style.display=o?'':'none';
Â Â t.textContent=o?'â–¼ collapse':'â–¶ expand';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMode(m){
Â Â gMode=m;
Â Â ['kml','shape','pixel'].forEach(n=>{
Â Â Â Â document.getElementById('tab-'+n).classList.toggle('on',n===m);
Â Â Â Â document.getElementById('sb-'+n).style.display=n===m?'':'none';
Â Â });
Â Â document.getElementById('kmlWrap').style.display=m==='kml'?'':'none';
Â Â document.getElementById('pixPanel').style.display=(m==='pixel'&&gPixels)?'':'none';
Â Â const cfg={
Â Â Â Â kml:{A:'KML Points',B:'Road Blocks',C:'Checkpoints',D:'Circuit Length'},
Â Â Â Â shape:{A:'Lines',B:'Total Blocks',C:'Unique IDs',D:''},
Â Â Â Â pixel:{A:'Pixels',B:'Width (px)',C:'Height (px)',D:''},
Â Â };
Â Â Object.keys(cfg[m]).forEach(k=>{document.getElementById('sl'+k).textContent=cfg[m][k];});
Â Â document.getElementById('topInfo').textContent={
Â Â Â Â kml:'KML â†’ 1:1 REAL-WORLD CIRCUIT',
Â Â Â Â shape:'MANUAL SHAPE BUILDER',
Â Â Â Â pixel:'IMAGE â†’ PIXEL ART TRACK',
Â Â }[m];
Â Â if(m==='shape')refreshShapeUI();
}
function setStat(id,v){document.getElementById('s'+id).textContent=v??'â€”';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENCODING ENGINE (shared)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function zlibCompress(data){
Â Â const cs=new CompressionStream('deflate');
Â Â const w=cs.writable.getWriter();
Â Â w.write(data instanceof Uint8Array?data:new Uint8Array(data));w.close();
Â Â const chunks=[];const reader=cs.readable.getReader();
Â Â for(;;){const{done,value}=await reader.read();if(done)break;chunks.push(value);}
Â Â const out=new Uint8Array(chunks.reduce((s,c)=>s+c.length,0));
Â Â let off=0;chunks.forEach(c=>{out.set(c,off);off+=c.length;});return out;
}
function encode62(buf){
Â Â let b=0,r='';
Â Â while(b<buf.length*8){
Â Â Â Â const bi=b>>>3,off=b&7;if(bi>=buf.length)break;
Â Â Â Â let v=off<=2||bi>=buf.length-1?(buf[bi]>>>off)&63:((buf[bi]>>>off)&63)|((buf[bi+1]&(63>>>(8-off)))<<(8-off));
Â Â Â Â if((v&30)===30){v&=31;b+=5;}else b+=6;r+=CHARS[v];
Â Â }return r;
}
const gBN=m=>m<128?1:m<32768?2:m<8388608?3:4;
const wU32=(b,v)=>b.push(v&255,(v>>8)&255,(v>>16)&255,(v>>24)&255);
const wC=(b,v,n)=>{for(let i=0;i<n;i++)b.push((v>>(i*8))&255);};

function buildBinary(ll){
Â Â const all=ll.flatMap(l=>l.points);
Â Â if(!all.length)return new Uint8Array(0);
Â Â let mnX=Infinity,mnY=Infinity,mnZ=Infinity;
Â Â for(const p of all){if(p.x<mnX)mnX=p.x;if(p.y<mnY)mnY=p.y;if(p.z<mnZ)mnZ=p.z;}
Â Â const sx=mnX<0?-mnX:0,sy=mnY<0?-mnY:0,sz=mnZ<0?-mnZ:0;
Â Â let mxX=0,mxY=0,mxZ=0;
Â Â for(const p of all){mxX=Math.max(mxX,p.x+sx);mxY=Math.max(mxY,p.y+sy);mxZ=Math.max(mxZ,p.z+sz);}
Â Â const bin=[];
Â Â bin.push(0,0);wU32(bin,0);wU32(bin,0);wU32(bin,0);
Â Â const xB=gBN(mxX),yB=gBN(mxY),zB=gBN(mxZ);
Â Â bin.push((zB<<4)|(yB<<2)|xB);
Â Â dbg(`Binary: max=(${mxX},${mxY},${mxZ}) bw=(${xB},${yB},${zB}) shift=(${sx},${sy},${sz})`);
Â Â const g={};
Â Â for(const l of ll){
Â Â Â Â if(!g[l.id])g[l.id]=[];
Â Â Â Â for(const p of l.points)g[l.id].push({x:p.x+sx,y:p.y+sy,z:p.z+sz,rot:l.rot||0,dir:0,color:0,cpIdx:p.cpIndex??l.cpIndex??0});
Â Â }
Â Â for(const id of Object.keys(g).sort((a,b)=>+a-+b)){
Â Â Â Â const blocks=g[id];bin.push(+id);wU32(bin,blocks.length);
Â Â Â Â for(const b of blocks){
Â Â Â Â Â Â wC(bin,b.x,xB);wC(bin,b.y,yB);wC(bin,b.z,zB);
Â Â Â Â Â Â bin.push(b.rot,b.dir,b.color);
Â Â Â Â Â Â if(+id===75)bin.push(b.cpIdx&0xff,0);
Â Â Â Â Â Â if([65,77].includes(+id))bin.push(0,0);
Â Â Â Â Â Â if([91,92,93].includes(+id))wU32(bin,0);
Â Â Â Â }
Â Â }
Â Â dbg(`Binary: ${bin.length} bytes â€” IDs: ${Object.keys(g).map(id=>`${id}Ã—${g[id].length}`).join(', ')}`,'ok');
Â Â return new Uint8Array(bin);
}

async function encodeTrack(ll,name,author){
Â Â const bin=buildBinary(ll);
Â Â const te=new TextEncoder();
Â Â const nb=te.encode(name),ab=te.encode(author);
Â Â const pre=new Uint8Array([nb.length,...nb,ab.length,...ab]);
Â Â const full=new Uint8Array(pre.length+bin.length);
Â Â full.set(pre);full.set(bin,pre.length);
Â Â const c1=await zlibCompress(full),b1=encode62(c1);
Â Â const c2=await zlibCompress(te.encode(b1));
Â Â return'PolyTrack1'+encode62(c2);
}

function emitCode(code){
Â Â gCode=code;
Â Â document.getElementById('outputCode').textContent=code;
Â Â setStat('E',(code.length/1024).toFixed(1)+' KB');
Â Â log(`Done â€” ${code.length} chars`,'ok');
Â Â dbg(`Encoded: ${code.length} chars`,'ok');
}
function copyCode(){
Â Â if(!gCode){toast('Generate a track first');return;}
Â Â navigator.clipboard.writeText(gCode).then(()=>toast('Copied!'));
}
function downloadCode(){
Â Â if(!gCode){toast('Generate a track first');return;}
Â Â const name=(document.getElementById(gMode+'TrackName')?.value||'polytrack').replace(/\W+/g,'_');
Â Â const a=document.createElement('a');
Â Â a.href=URL.createObjectURL(new Blob([gCode],{type:'text/plain'}));
Â Â a.download=name+'.txt';a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KML MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CS=4; // PolyTrack coordinate scale
let _lastKMLResult=null;

function parseKML(txt){
Â Â txt=txt.replace(/^\uFEFF/,'').replace(/<\?xml[^>]*\?>\s*/i,'');
Â Â const doc=new DOMParser().parseFromString(txt,'text/xml');
Â Â const el=doc.querySelector('coordinates')||doc.getElementsByTagNameNS('http://www.opengis.net/kml/2.2','coordinates')[0];
Â Â if(!el)throw new Error('No <coordinates> found â€” paste a valid KML path file.');
Â Â const coords=[];
Â Â for(const pt of el.textContent.trim().split(/\s+/)){
Â Â Â Â const p=pt.split(',').map(Number);
Â Â Â Â if(p.length>=2&&!p.some(isNaN))coords.push({lon:p[0],lat:p[1],alt:p[2]||0});
Â Â }
Â Â if(coords.length<2)throw new Error('KML must contain at least 2 coordinate points.');
Â Â return coords;
}
function haversineM(lon1,lat1,lon2,lat2){
Â Â const R=6371000,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
Â Â const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
Â Â return R*2*Math.asin(Math.sqrt(a));
}
function toLocal(coords){
Â Â const o=coords[0];
Â Â return coords.map(c=>({
Â Â Â Â x:haversineM(o.lon,o.lat,c.lon,o.lat)*(c.lon>=o.lon?1:-1),
Â Â Â Â z:haversineM(o.lon,o.lat,o.lon,c.lat)*(c.lat>=o.lat?1:-1),
Â Â Â Â alt:c.alt
Â Â }));
}
function rdp(pts,eps){
Â Â if(pts.length<=2)return pts;
Â Â let maxD=0,maxI=0;
Â Â const s=pts[0],e=pts[pts.length-1],dx=e.x-s.x,dz=e.z-s.z,len=Math.sqrt(dx*dx+dz*dz);
Â Â for(let i=1;i<pts.length-1;i++){
Â Â Â Â const d=len===0?Math.sqrt((pts[i].x-s.x)**2+(pts[i].z-s.z)**2):Math.abs(dz*pts[i].x-dx*pts[i].z+e.x*s.z-e.z*s.x)/len;
Â Â Â Â if(d>maxD){maxD=d;maxI=i;}
Â Â }
Â Â if(maxD>eps){const L=rdp(pts.slice(0,maxI+1),eps),R=rdp(pts.slice(maxI),eps);return[...L.slice(0,-1),...R];}
Â Â return[s,e];
}
function angleBetween(ax,az,bx,bz){
Â Â const dot=ax*bx+az*bz,la=Math.sqrt(ax*ax+az*az),lb=Math.sqrt(bx*bx+bz*bz);
Â Â if(!la||!lb)return 0;
Â Â return Math.acos(Math.max(-1,Math.min(1,dot/(la*lb))))*180/Math.PI;
}
// Ramp rotation table â€” same data confirmed from 4-direction decode
// cardinal: 0=-ZÂ Â 1=-XÂ Â 2=+ZÂ Â 3=+X
const RAMP_ROTS=[
Â Â {asc145:0,asc146:2,dsc146:0,dsc145:2}, // travel -Z
Â Â {asc145:1,asc146:3,dsc146:1,dsc145:3}, // travel -X
Â Â {asc145:2,asc146:0,dsc146:2,dsc145:0}, // travel +Z
Â Â {asc145:3,asc146:1,dsc146:3,dsc145:1}, // travel +X
];
// Snap a dx,dz vector to cardinal 0=-Z 1=-X 2=+Z 3=+X
function snapCardinal(dx,dz){
Â Â if(Math.abs(dz)>=Math.abs(dx)) return dz<=0?0:2;
Â Â return dx<=0?1:3;
}

function kmlPathToLines(local,ox,oy,oz,rw,thr,useElev){
Â Â // 1 Y unit = 5 real metres (from decoded hill: 8 coord units horiz, 2Y = 10m rise)
Â Â const Y_PER_M = 1/5;

Â Â // Convert to block-space waypoints
Â Â const bp=local.map(p=>({
Â Â Â Â bx:(Math.round(p.x/20)+ox)*CS,
Â Â Â Â bz:(Math.round(p.z/20)+oz)*CS,
Â Â Â Â by:useElev ? Math.round(p.alt*Y_PER_M) : oy*CS,
Â Â Â Â alt:p.alt
Â Â }));

Â Â // Deduplicate consecutive same-XZ positions (merge Y by averaging)
Â Â const pts=[{...bp[0]}];
Â Â for(let i=1;i<bp.length;i++){
Â Â Â Â const pv=pts[pts.length-1];
Â Â Â Â if(bp[i].bx!==pv.bx||bp[i].bz!==pv.bz){
Â Â Â Â Â Â pts.push({...bp[i]});
Â Â Â Â } else {
Â Â Â Â Â Â pv.by=Math.round((pv.by+bp[i].by)/2);
Â Â Â Â }
Â Â }

Â Â // Width helpers
Â Â const hW=Math.floor(rw/2)*CS, fW=(rw-1-Math.floor(rw/2))*CS;

Â Â // Collectors
Â Â const flatSeen=new Set(), flatRoad=[];
Â Â // rampBlocks: [{id,rot,x,y,z}] â€” individual blocks, deduplicated by key
Â Â const rampSeen=new Set(), rampBlocks=[];
Â Â const cps=[];

Â Â function addFlat(x,y,z,cardinal){
Â Â Â Â // Lay a road slab centred at (x,y,z), width spread perpendicular to cardinal
Â Â Â Â const perpZ=(cardinal===0||cardinal===2); // hill travels in Z â†’ width spreads in X
Â Â Â Â const nX=perpZ?1:0, nZ=perpZ?0:1;
Â Â Â Â const slab=rw<=1?[{x,y,z}]:line3D(x-nX*hW,y,z-nZ*hW, x+nX*fW,y,z+nZ*fW);
Â Â Â Â for(const sp of slab){
Â Â Â Â Â Â const k=`${sp.x},${sp.y},${sp.z}`;
Â Â Â Â Â Â if(!flatSeen.has(k)){flatSeen.add(k);flatRoad.push({x:sp.x,y:sp.y,z:sp.z});}
Â Â Â Â }
Â Â }

Â Â function addRamp(id,rot,x,y,z,cardinal){
Â Â Â Â // Lay a ramp block slab centred at (x,y,z), width spread perpendicular to cardinal
Â Â Â Â const perpZ=(cardinal===0||cardinal===2);
Â Â Â Â const halfW=Math.floor(rw/2);
Â Â Â Â for(let w=0;w<rw;w++){
Â Â Â Â Â Â const off=(w-halfW)*CS;
Â Â Â Â Â Â const wx=x+(perpZ?off:0), wz=z+(perpZ?0:off);
Â Â Â Â Â Â const k=`${id},${rot},${wx},${y},${wz}`;
Â Â Â Â Â Â if(!rampSeen.has(k)){rampSeen.add(k);rampBlocks.push({id,rot,x:wx,y,z:wz});}
Â Â Â Â }
Â Â }

Â Â for(let i=0;i<pts.length-1;i++){
Â Â Â Â const a=pts[i], b=pts[i+1];
Â Â Â Â const ddx=b.bx-a.bx, ddz=b.bz-a.bz;
Â Â Â Â const cardinal=snapCardinal(ddx,ddz);
Â Â Â Â const rots=RAMP_ROTS[cardinal];

Â Â Â Â // Step direction unit vectors in coord space
Â Â Â Â const stepX= cardinal===3?CS : cardinal===1?-CS : 0;
Â Â Â Â const stepZ= cardinal===2?CS : cardinal===0?-CS : 0;

Â Â Â Â // Horizontal span (coord units along dominant axis)
Â Â Â Â const hSpan=Math.abs(cardinal<2 ? ddz : ddx);

Â Â Â Â if(!useElev){
Â Â Â Â Â Â // Original flat mode â€” walk the line with line3D
Â Â Â Â Â Â const nx=Math.abs(ddx)>=Math.abs(ddz)?0:1, nz=nx?0:1;
Â Â Â Â Â Â const center=line3D(a.bx,a.by,a.bz,b.bx,b.by,b.bz);
Â Â Â Â Â Â for(const cb of center){
Â Â Â Â Â Â Â Â const slab=rw<=1?[cb]:line3D(cb.x-nx*hW,cb.y,cb.z-nz*hW,cb.x+nx*fW,cb.y,cb.z+nz*fW);
Â Â Â Â Â Â Â Â for(const sp of slab){
Â Â Â Â Â Â Â Â Â Â const k=`${sp.x},${sp.y},${sp.z}`;
Â Â Â Â Â Â Â Â Â Â if(!flatSeen.has(k)){flatSeen.add(k);flatRoad.push({x:sp.x,y:sp.y,z:sp.z});}
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â } else {
Â Â Â Â Â Â // Elevation mode
Â Â Â Â Â Â // dY needed across this segment
Â Â Â Â Â Â const dY=b.by-a.by;Â Â // signed, in Y units
Â Â Â Â Â Â const ascending=dY>0;
Â Â Â Â Â Â const sign=ascending?1:-1;

Â Â Â Â Â Â // Each ramp module = 16 coord units horiz, Â±2 Y
Â Â Â Â Â Â // Fit as many ramp modules as needed and as available space allows
Â Â Â Â Â Â const rampsNeeded=Math.abs(Math.round(dY/2));
Â Â Â Â Â Â const maxRamps=Math.floor(hSpan/16);
Â Â Â Â Â Â const nRamps=Math.min(rampsNeeded,maxRamps);
Â Â Â Â Â Â // Remaining horizontal units filled with flat road
Â Â Â Â Â Â const rampHoriz=nRamps*16;
Â Â Â Â Â Â const flatHoriz=hSpan-rampHoriz;

Â Â Â Â Â Â // Strategy: cluster ramps together at the start of the climb/descent
Â Â Â Â Â Â // (for ascent: ramp early, flat after; for descent: flat first, ramp late)
Â Â Â Â Â Â // Walk from a toward b in CS-unit steps

Â Â Â Â Â Â let cx=a.bx, cz=a.bz, cy=a.by;
Â Â Â Â Â Â let pos=0; // how many coord units we've walked
Â Â Â Â Â Â let rampsLeft=nRamps;

Â Â Â Â Â Â // Helper: advance pos and cursor by `units` coord units
Â Â Â Â Â Â const advance=(units)=>{ cx+=stepX*(units/CS); cz+=stepZ*(units/CS); pos+=units; };

Â Â Â Â Â Â if(ascending){
Â Â Â Â Â Â Â Â // Place ramps first, then flat
Â Â Â Â Â Â Â Â while(rampsLeft>0 && pos+16<=hSpan+0.5){
Â Â Â Â Â Â Â Â Â Â // ID145 entry: positioned at cx + half a CS step so it sits in the middle of its 8-unit zone
Â Â Â Â Â Â Â Â Â Â addRamp(145, rots.asc145, cx+stepX*1, cy,Â Â Â Â cz+stepZ*1, cardinal);
Â Â Â Â Â Â Â Â Â Â advance(8);
Â Â Â Â Â Â Â Â Â Â // ID146 ramp: Y rises by 2
Â Â Â Â Â Â Â Â Â Â cy+=2;
Â Â Â Â Â Â Â Â Â Â addRamp(146, rots.asc146, cx+stepX*1, cy,Â Â Â Â cz+stepZ*1, cardinal);
Â Â Â Â Â Â Â Â Â Â advance(8);
Â Â Â Â Â Â Â Â Â Â rampsLeft--;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â // Fill remaining with flat
Â Â Â Â Â Â Â Â while(pos+CS<=hSpan+0.5){
Â Â Â Â Â Â Â Â Â Â addFlat(cx, cy, cz, cardinal);
Â Â Â Â Â Â Â Â Â Â advance(CS);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â // Descend: flat first, then ramps
Â Â Â Â Â Â Â Â const flatFirst=hSpan-nRamps*16;
Â Â Â Â Â Â Â Â let flatDone=0;
Â Â Â Â Â Â Â Â while(flatDone<flatFirst-0.5 && pos+CS<=hSpan+0.5){
Â Â Â Â Â Â Â Â Â Â addFlat(cx, cy, cz, cardinal);
Â Â Â Â Â Â Â Â Â Â advance(CS);
Â Â Â Â Â Â Â Â Â Â flatDone+=CS;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â while(rampsLeft>0 && pos+16<=hSpan+0.5){
Â Â Â Â Â Â Â Â Â Â // For descent: ID146 first (drops Y by 2), then ID145 exit
Â Â Â Â Â Â Â Â Â Â cy-=2;
Â Â Â Â Â Â Â Â Â Â addRamp(146, rots.dsc146, cx+stepX*1, cy,Â Â Â Â cz+stepZ*1, cardinal);
Â Â Â Â Â Â Â Â Â Â advance(8);
Â Â Â Â Â Â Â Â Â Â addRamp(145, rots.dsc145, cx+stepX*1, cy,Â Â Â Â cz+stepZ*1, cardinal);
Â Â Â Â Â Â Â Â Â Â advance(8);
Â Â Â Â Â Â Â Â Â Â rampsLeft--;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â // Any remaining flat (e.g. rounding residual)
Â Â Â Â Â Â Â Â while(pos+CS<=hSpan+0.5){
Â Â Â Â Â Â Â Â Â Â addFlat(cx, cy, cz, cardinal);
Â Â Â Â Â Â Â Â Â Â advance(CS);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }

Â Â Â Â Â Â // Always stamp the endpoint as flat road (anchors the destination height)
Â Â Â Â Â Â addFlat(b.bx, b.by, b.bz, cardinal);
Â Â Â Â }

Â Â Â Â // Checkpoint detection (turn angle)
Â Â Â Â if(i<pts.length-2){
Â Â Â Â Â Â const c2=pts[i+2];
Â Â Â Â Â Â const ang=angleBetween(b.bx-a.bx,b.bz-a.bz,c2.bx-b.bx,c2.bz-b.bz);
Â Â Â Â Â Â if(ang>=thr)cps.push({bx:b.bx,by:b.by,bz:b.bz});
Â Â Â Â }
Â Â }

Â Â // Build output line list
Â Â const out=[];
Â Â if(flatRoad.length) out.push({id:25,points:flatRoad,rot:0});
Â Â // Each ramp block is its own entry so its id/rot are respected by the encoder
Â Â for(const rb of rampBlocks){
Â Â Â Â out.push({id:rb.id,rot:rb.rot,points:[{x:rb.x,y:rb.y,z:rb.z}]});
Â Â }
Â Â cps.forEach((cp,i)=>out.push({
Â Â Â Â id:75,points:[{x:cp.bx,y:cp.by,z:cp.bz,cpIndex:i}],rot:0,cpIndex:i
Â Â }));
Â Â out.push({id:92,points:[{x:pts[0].bx,y:pts[0].by,z:pts[0].bz}],rot:0});
Â Â const last=pts[pts.length-1];
Â Â out.push({id:76,points:[{x:last.bx,y:last.by,z:last.bz}],rot:0});

Â Â return{lines:out,blockPts:pts,cps,roadBlocks:flatRoad.length+rampBlocks.length};
}

function redrawKML(){
Â Â if(_lastKMLResult)drawKMLCanvas(_lastKMLResult.blockPts,_lastKMLResult.cps);
}
function drawKMLCanvas(blockPts,cps){
Â Â const canvas=document.getElementById('kmlCanvas');
Â Â const ctx=canvas.getContext('2d');
Â Â const W=canvas.offsetWidth||800;canvas.width=W;
Â Â const dark=document.documentElement.getAttribute('data-theme')==='dark';
Â Â ctx.fillStyle=dark?'#08090f':'#f0f2f8';ctx.fillRect(0,0,W,canvas.height);
Â Â if(!blockPts||blockPts.length<2){return;}
Â Â const xs=blockPts.map(p=>p.bx),zs=blockPts.map(p=>p.bz);
Â Â const mnX=Math.min(...xs),mxX=Math.max(...xs),mnZ=Math.min(...zs),mxZ=Math.max(...zs);
Â Â const pad=42,rX=mxX-mnX||1,rZ=mxZ-mnZ||1;
Â Â const sc=Math.min((W-pad*2)/rX,(canvas.height-pad*2)/rZ);
Â Â const toC=(bx,bz)=>({cx:pad+(bx-mnX)*sc,cy:pad+(bz-mnZ)*sc});
Â Â // Dot grid
Â Â ctx.fillStyle=dark?'rgba(255,255,255,.025)':'rgba(0,0,0,.05)';
Â Â const gs=Math.max(1,Math.round(38/sc));
Â Â for(let gx=0;gx<=rX;gx+=gs)for(let gz=0;gz<=rZ;gz+=gs){const{cx,cy}=toC(mnX+gx,mnZ+gz);ctx.fillRect(cx,cy,1,1);}

Â Â const useElev=document.getElementById('useElevation').checked;
Â Â const ys=blockPts.map(p=>p.by);
Â Â const mnY=Math.min(...ys),mxY=Math.max(...ys),rY=mxY-mnY||1;

Â Â // Draw track â€” colour by elevation if active, else plain amber
Â Â ctx.lineWidth=Math.max(1.5,sc*.65);ctx.lineJoin='round';ctx.lineCap='round';
Â Â if(useElev && rY>0){
Â Â Â Â // Draw segment by segment with elevation colour (blue=low â†’ red=high)
Â Â Â Â for(let i=0;i<blockPts.length-1;i++){
Â Â Â Â Â Â const t=(blockPts[i].by-mnY)/rY;
Â Â Â Â Â Â // Blue â†’ cyan â†’ green â†’ yellow â†’ red
Â Â Â Â Â Â const h=(1-t)*240; // hue 240=blue â†’ 0=red
Â Â Â Â Â Â ctx.strokeStyle=`hsl(${h},90%,55%)`;
Â Â Â Â Â Â ctx.shadowColor=ctx.strokeStyle;ctx.shadowBlur=4;
Â Â Â Â Â Â const{cx:x1,cy:y1}=toC(blockPts[i].bx,blockPts[i].bz);
Â Â Â Â Â Â const{cx:x2,cy:y2}=toC(blockPts[i+1].bx,blockPts[i+1].bz);
Â Â Â Â Â Â ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
Â Â Â Â }
Â Â Â Â ctx.shadowBlur=0;
Â Â } else {
Â Â Â Â const acc=getComputedStyle(document.documentElement).getPropertyValue('--acc').trim()||'#f5a623';
Â Â Â Â ctx.shadowColor=acc;ctx.shadowBlur=5;ctx.strokeStyle=acc;
Â Â Â Â ctx.beginPath();
Â Â Â Â const{cx:sx0,cy:sz0}=toC(blockPts[0].bx,blockPts[0].bz);ctx.moveTo(sx0,sz0);
Â Â Â Â for(let i=1;i<blockPts.length;i++){const{cx,cy}=toC(blockPts[i].bx,blockPts[i].bz);ctx.lineTo(cx,cy);}
Â Â Â Â ctx.stroke();ctx.shadowBlur=0;
Â Â }

Â Â // Checkpoints
Â Â ctx.fillStyle='rgba(57,200,224,.85)';
Â Â for(const cp of cps){const{cx,cy}=toC(cp.bx,cp.bz);ctx.beginPath();ctx.arc(cx,cy,3,0,Math.PI*2);ctx.fill();}
Â Â // Start dot
Â Â const{cx:sc2,cy:sy}=toC(blockPts[0].bx,blockPts[0].bz);
Â Â ctx.shadowBlur=10;ctx.shadowColor='#3dd68c';ctx.fillStyle='#3dd68c';
Â Â ctx.beginPath();ctx.arc(sc2,sy,5.5,0,Math.PI*2);ctx.fill();
Â Â // Finish dot
Â Â const{cx:fc,cy:fy}=toC(blockPts[blockPts.length-1].bx,blockPts[blockPts.length-1].bz);
Â Â ctx.shadowColor='#e04040';ctx.fillStyle='#e04040';
Â Â ctx.beginPath();ctx.arc(fc,fy,5.5,0,Math.PI*2);ctx.fill();
Â Â ctx.shadowBlur=0;
Â Â // Labels
Â Â ctx.font='10px "JetBrains Mono",monospace';
Â Â ctx.fillStyle='#3dd68c';ctx.fillText('START',sc2+8,sy+3);
Â Â ctx.fillStyle='#e04040';ctx.fillText('FINISH',fc+8,fy+3);

Â Â // Elevation colour legend
Â Â if(useElev && rY>0){
Â Â Â Â const lx=pad+4, ly=canvas.height-18, lw=80;
Â Â Â Â for(let px=0;px<lw;px++){
Â Â Â Â Â Â const h=(1-px/lw)*240;
Â Â Â Â Â Â ctx.fillStyle=`hsl(${h},90%,55%)`;
Â Â Â Â Â Â ctx.fillRect(lx+px,ly,1,8);
Â Â Â Â }
Â Â Â Â ctx.font='8px "JetBrains Mono",monospace';
Â Â Â Â ctx.fillStyle=dark?'rgba(255,255,255,.5)':'rgba(0,0,0,.4)';
Â Â Â Â ctx.fillText(`${Math.round(mnY*5)}m`,lx,ly-2);
Â Â Â Â ctx.fillText(`${Math.round(mxY*5)}m`,lx+lw-20,ly-2);
Â Â } else {
Â Â Â Â ctx.fillStyle='rgba(57,200,224,.8)';ctx.beginPath();ctx.arc(pad+4,canvas.height-17,3,0,Math.PI*2);ctx.fill();
Â Â Â Â ctx.fillStyle=dark?'rgba(255,255,255,.22)':'rgba(0,0,0,.28)';
Â Â Â Â ctx.font='10px "JetBrains Mono",monospace';
Â Â Â Â ctx.fillText('CHECKPOINT',pad+11,canvas.height-13);
Â Â }
Â Â document.getElementById('cvInfo').textContent=
Â Â Â Â `${Math.round(rX/CS)}Ã—${Math.round(rZ/CS)} blocks Â· ${(Math.round(rX/CS)*20/1000).toFixed(1)}Ã—${(Math.round(rZ/CS)*20/1000).toFixed(1)} km`;
}

async function generateKML(){
Â Â const btn=document.getElementById('kmlBtn');
Â Â btn.disabled=true;btn.textContent='â³ Workingâ€¦';
Â Â try{
Â Â Â Â const txt=document.getElementById('kmlInput').value.trim();
Â Â Â Â if(!txt){log('Paste or load a KML file first.','err');return;}
Â Â Â Â dbg('=== KML Generate ===');log('Parsing KMLâ€¦','warn');
Â Â Â Â const coords=parseKML(txt);
Â Â Â Â let dist=0;
Â Â Â Â for(let i=1;i<coords.length;i++)dist+=haversineM(coords[i-1].lon,coords[i-1].lat,coords[i].lon,coords[i].lat);
Â Â Â Â let local=toLocal(coords);
Â Â Â Â if(document.getElementById('smoothPath').checked){
Â Â Â Â Â Â const tol=+document.getElementById('smoothTol').value||10;
Â Â Â Â Â Â const before=local.length;local=rdp(local,tol);
Â Â Â Â Â Â dbg(`RDP: ${before}â†’${local.length} pts (tol=${tol}m)`,'warn');
Â Â Â Â }
Â Â Â Â const ox=+document.getElementById('originX').value||500;
Â Â Â Â const oy=+document.getElementById('originY').value||0;
Â Â Â Â const oz=+document.getElementById('originZ').value||500;
Â Â Â Â const rw=+document.getElementById('roadWidth').value||1;
Â Â Â Â const thr=+document.getElementById('turnAngle').value||20;
Â Â Â Â const useElev=document.getElementById('useElevation').checked;
Â Â Â Â const result=kmlPathToLines(local,ox,oy,oz,rw,thr,useElev);
Â Â Â Â _lastKMLResult=result;
Â Â Â Â setStat('A',coords.length);document.getElementById('slA').textContent='KML Points';
Â Â Â Â setStat('B',result.roadBlocks.toLocaleString());document.getElementById('slB').textContent='Road Blocks';
Â Â Â Â setStat('C',result.cps.length);document.getElementById('slC').textContent='Checkpoints';
Â Â Â Â if(useElev){
Â Â Â Â Â Â const alts=local.map(p=>p.alt);
Â Â Â Â Â Â const elevRange=Math.round(Math.max(...alts)-Math.min(...alts));
Â Â Â Â Â Â setStat('D',elevRange+'m');document.getElementById('slD').textContent='Elev Range';
Â Â Â Â } else {
Â Â Â Â Â Â setStat('D',(dist/1000).toFixed(2)+' km');document.getElementById('slD').textContent='Circuit Length';
Â Â Â Â }
Â Â Â Â drawKMLCanvas(result.blockPts,result.cps);
Â Â Â Â log('Compressingâ€¦','warn');
Â Â Â Â const code=await encodeTrack(result.lines,
Â Â Â Â Â Â document.getElementById('kmlTrackName').value||'My Circuit',
Â Â Â Â Â Â document.getElementById('kmlAuthor').value||'Builder');
Â Â Â Â emitCode(code);toast('Circuit generated!');
Â Â }catch(e){dbg('ERROR: '+e.message,'err');log(e.message,'err');}
Â Â finally{btn.disabled=false;btn.textContent='âš¡ Generate Circuit Code';}
}

// Elevation checkbox hint
document.getElementById('useElevation').addEventListener('change',function(){
Â Â document.getElementById('elevNote').style.display=this.checked?'':'none';
});

// KML file drag/drop
const dz=document.getElementById('dropZone'),fi=document.getElementById('fileInput');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over')});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');if(e.dataTransfer.files[0])loadKMLFile(e.dataTransfer.files[0]);});
fi.addEventListener('change',()=>{if(fi.files[0])loadKMLFile(fi.files[0]);});
function loadKMLFile(f){
Â Â const r=new FileReader();
Â Â r.onload=ev=>{document.getElementById('kmlInput').value=ev.target.result;log('File loaded: '+f.name,'ok');toast('Loaded '+f.name);};
Â Â r.readAsText(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHAPE BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function line3D(x1,y1,z1,x2,y2,z2){
Â Â const pts=[],dx=x2-x1,dy=y2-y1,dz=z2-z1;
Â Â const ax=Math.abs(dx),ay=Math.abs(dy),az=Math.abs(dz);
Â Â const sx=dx>0?1:-1,sy=dy>0?1:-1,sz=dz>0?1:-1;
Â Â let x=x1,y=y1,z=z1;
Â Â if(ax>=ay&&ax>=az){
Â Â Â Â let yd=ay-ax/2,zd=az-ax/2;
Â Â Â Â for(;;){pts.push({x,y,z});if(x===x2)return pts;x+=sx;if(yd>=0){y+=sy;yd-=ax;}yd+=ay;if(zd>=0){z+=sz;zd-=ax;}zd+=az;}
Â Â }else if(ay>=ax&&ay>=az){
Â Â Â Â let xd=ax-ay/2,zd=az-ay/2;
Â Â Â Â for(;;){pts.push({x,y,z});if(y===y2)return pts;y+=sy;if(xd>=0){x+=sx;xd-=ay;}xd+=ax;if(zd>=0){z+=sz;zd-=ay;}zd+=az;}
Â Â }else{
Â Â Â Â let xd=ax-az/2,yd=ay-az/2;
Â Â Â Â for(;;){pts.push({x,y,z});if(z===z2)return pts;z+=sz;if(xd>=0){x+=sx;xd-=az;}xd+=ax;if(yd>=0){y+=sy;yd-=az;}yd+=ay;}
Â Â }
}

function addShape(){
Â Â const type=document.getElementById('shapeType').value;
Â Â if(type==='line'){
Â Â Â Â gLines.push({id:+document.getElementById('lineId').value,rot:+document.getElementById('lineRot').value,
Â Â Â Â Â Â points:line3D(+document.getElementById('lsx').value,+document.getElementById('lsy').value,+document.getElementById('lsz').value,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â +document.getElementById('lex').value,+document.getElementById('ley').value,+document.getElementById('lez').value)});
Â Â }else if(type==='filledRect'){
Â Â Â Â const plane=document.getElementById('rectPlane').value,fixed=+document.getElementById('fixedCoord').value;
Â Â Â Â let mn1=+document.getElementById('rectMin1').value,mx1=+document.getElementById('rectMax1').value;
Â Â Â Â let mn2=+document.getElementById('rectMin2').value,mx2=+document.getElementById('rectMax2').value;
Â Â Â Â const id=+document.getElementById('rectId').value,rot=+document.getElementById('rectRot').value;
Â Â Â Â if(mn1>mx1)[mn1,mx1]=[mx1,mn1];if(mn2>mx2)[mn2,mx2]=[mx2,mn2];
Â Â Â Â if(plane==='xz')for(let z=mn2;z<=mx2;z++)gLines.push({id,rot,points:line3D(mn1,fixed,z,mx1,fixed,z)});
Â Â Â Â else if(plane==='xy')for(let y=mn2;y<=mx2;y++)gLines.push({id,rot,points:line3D(mn1,y,fixed,mx1,y,fixed)});
Â Â Â Â else for(let z=mn2;z<=mx2;z++)gLines.push({id,rot,points:line3D(fixed,mn1,z,fixed,mx1,z)});
Â Â }else if(type==='hollowCube'){
Â Â Â Â let[mnX,mnY,mnZ]=[+document.getElementById('hcMinX').value,+document.getElementById('hcMinY').value,+document.getElementById('hcMinZ').value];
Â Â Â Â let[mxX,mxY,mxZ]=[+document.getElementById('hcMaxX').value,+document.getElementById('hcMaxY').value,+document.getElementById('hcMaxZ').value];
Â Â Â Â if(mnX>mxX)[mnX,mxX]=[mxX,mnX];if(mnY>mxY)[mnY,mxY]=[mxY,mnY];if(mnZ>mxZ)[mnZ,mxZ]=[mxZ,mnZ];
Â Â Â Â const id=+document.getElementById('hcId').value,rot=+document.getElementById('hcRot').value;
Â Â Â Â for(let z=mnZ;z<=mxZ;z++){gLines.push({id,rot,points:line3D(mnX,mnY,z,mxX,mnY,z)});gLines.push({id,rot,points:line3D(mnX,mxY,z,mxX,mxY,z)});}
Â Â Â Â for(let y=mnY;y<=mxY;y++){gLines.push({id,rot,points:line3D(mnX,y,mnZ,mxX,y,mnZ)});gLines.push({id,rot,points:line3D(mnX,y,mxZ,mxX,y,mxZ)});}
Â Â Â Â for(let z=mnZ;z<=mxZ;z++){gLines.push({id,rot,points:line3D(mnX,mnY,z,mnX,mxY,z)});gLines.push({id,rot,points:line3D(mxX,mnY,z,mxX,mxY,z)});}
Â Â }else{
Â Â Â Â let[mnX,mnY,mnZ]=[+document.getElementById('fcMinX').value,+document.getElementById('fcMinY').value,+document.getElementById('fcMinZ').value];
Â Â Â Â let[mxX,mxY,mxZ]=[+document.getElementById('fcMaxX').value,+document.getElementById('fcMaxY').value,+document.getElementById('fcMaxZ').value];
Â Â Â Â if(mnX>mxX)[mnX,mxX]=[mxX,mnX];if(mnY>mxY)[mnY,mxY]=[mxY,mnY];if(mnZ>mxZ)[mnZ,mxZ]=[mxZ,mnZ];
Â Â Â Â const id=+document.getElementById('fcId').value,rot=+document.getElementById('fcRot').value;
Â Â Â Â for(let y=mnY;y<=mxY;y++)for(let z=mnZ;z<=mxZ;z++)gLines.push({id,rot,points:line3D(mnX,y,z,mxX,y,z)});
Â Â }
Â Â refreshShapeUI();toast('Shape added');
}

function removeShape(i){gLines.splice(i,1);refreshShapeUI();}
function clearLines(){gLines=[];refreshShapeUI();toast('Cleared');}

function refreshShapeUI(){
Â Â const total=gLines.reduce((s,l)=>s+l.points.length,0);
Â Â const ids=new Set(gLines.map(l=>l.id));
Â Â if(gMode==='shape'){setStat('A',gLines.length);setStat('B',total.toLocaleString());setStat('C',ids.size);}
Â Â const list=document.getElementById('linesList');
Â Â if(!gLines.length){
Â Â Â Â list.innerHTML='<div class="empty-st"><div>â—ˆ</div><p>No shapes yet.<br>Add shapes above to build your track.</p></div>';
Â Â Â Â return;
Â Â }
Â Â list.innerHTML=gLines.map((l,i)=>`
Â Â Â Â <div class="li">
Â Â Â Â Â Â <div class="id-badge">ID&nbsp;${l.id}</div>
Â Â Â Â Â Â <div class="li-info">
Â Â Â Â Â Â Â Â ${ID_NAMES[l.id]?`<div class="li-name">${ID_NAMES[l.id]}</div>`:''}
Â Â Â Â Â Â Â Â <div class="li-meta">${l.points.length} block${l.points.length!==1?'s':''}</div>
Â Â Â Â Â Â Â Â <div class="li-coords">(${l.points[0].x},${l.points[0].y},${l.points[0].z}) â†’ (${l.points[l.points.length-1].x},${l.points[l.points.length-1].y},${l.points[l.points.length-1].z})</div>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <button class="btn btn-del btn-sm" onclick="removeShape(${i})">âœ•</button>
Â Â Â Â </div>`).join('');
}

async function generateShape(){
Â Â if(!gLines.length){toast('Add at least one shape first');return;}
Â Â log('Compressingâ€¦','warn');dbg('=== Shape Generate ===');
Â Â try{
Â Â Â Â const code=await encodeTrack(gLines,
Â Â Â Â Â Â document.getElementById('shapeTrackName').value||'My Track',
Â Â Â Â Â Â document.getElementById('shapeAuthor').value||'Builder');
Â Â Â Â emitCode(code);
Â Â Â Â const total=gLines.reduce((s,l)=>s+l.points.length,0);
Â Â Â Â setStat('A',gLines.length);setStat('B',total.toLocaleString());setStat('C',new Set(gLines.map(l=>l.id)).size);
Â Â Â Â toast('Track generated!');
Â Â }catch(e){dbg('ERROR: '+e.message,'err');log(e.message,'err');}
}

function generateTestTrack(){
Â Â gLines=[];
Â Â const mn=+document.getElementById('minId').value;
Â Â const mx=+document.getElementById('maxId').value;
Â Â gLines.push({id:92,points:line3D(0,0,0,0,0,0),rot:0});
Â Â let pos=0;
Â Â for(let i=mn;i<=mx;i++){pos+=20;gLines.push({id:i,points:line3D(pos,0,0,pos,0,0),rot:0});}
Â Â gLines.push({id:76,points:line3D(pos+20,0,0,pos+20,0,0),rot:0});
Â Â refreshShapeUI();
Â Â toast(`ID test track: IDs ${mn}â€“${mx}`);
}

function exportJSON(){
Â Â const a=document.createElement('a');
Â Â a.href=URL.createObjectURL(new Blob([JSON.stringify(gLines,null,2)],{type:'application/json'}));
Â Â a.download='shapes.json';a.click();
}

// Shape form switcher
document.getElementById('shapeType').addEventListener('change',()=>{
Â Â document.querySelectorAll('.sf').forEach(f=>f.style.display='none');
Â Â document.getElementById('form-'+document.getElementById('shapeType').value).style.display='';
Â Â if(document.getElementById('shapeType').value==='filledRect')syncRectLabels();
});
document.getElementById('rectPlane').addEventListener('change',syncRectLabels);
function syncRectLabels(){
Â Â const p=document.getElementById('rectPlane').value;
Â Â const M={xz:['Fixed Y','Min X','Max X','Min Z','Max Z'],xy:['Fixed Z','Min X','Max X','Min Y','Max Y'],yz:['Fixed X','Min Y','Max Y','Min Z','Max Z']};
Â Â const[fl,m1,x1,m2,x2]=M[p];
Â Â document.getElementById('fixedLabel').textContent=fl;
Â Â document.getElementById('min1Label').textContent=m1;document.getElementById('max1Label').textContent=x1;
Â Â document.getElementById('min2Label').textContent=m2;document.getElementById('max2Label').textContent=x2;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIXEL ART (3 shades)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pCvs=document.getElementById('previewCanvas');
const pCtx=pCvs.getContext('2d');
const BIN_CLR=['#1a2eaa','#7a7e96','#d8ddf0']; // dark / mid / light display colours

function processUpload(){
Â Â const file=document.getElementById('imgUpload').files[0];
Â Â if(!file){toast('Choose an image file first');return;}
Â Â const reader=new FileReader();
Â Â reader.onload=ev=>{
Â Â Â Â const img=new Image();
Â Â Â Â img.onload=()=>{
Â Â Â Â Â Â const res=Math.max(8,Math.min(256,+document.getElementById('resValue').value||64));
Â Â Â Â Â Â const keep=document.getElementById('preserveAspect').checked;
Â Â Â Â Â Â let tw,th;
Â Â Â Â Â Â if(keep){
Â Â Â Â Â Â Â Â if(img.width>=img.height){tw=res;th=Math.round(img.height*(res/img.width));}
Â Â Â Â Â Â Â Â else{th=res;tw=Math.round(img.width*(res/img.height));}
Â Â Â Â Â Â }else{tw=th=res;}
Â Â Â Â Â Â tw=Math.max(2,Math.min(256,tw));th=Math.max(2,Math.min(256,th));
Â Â Â Â Â Â // Downsample
Â Â Â Â Â Â const off=document.createElement('canvas');off.width=tw;off.height=th;
Â Â Â Â Â Â const oc=off.getContext('2d');oc.imageSmoothingEnabled=true;oc.drawImage(img,0,0,tw,th);
Â Â Â Â Â Â const imgd=oc.getImageData(0,0,tw,th);
Â Â Â Â Â Â // Compute luminance
Â Â Â Â Â Â const lum=new Float32Array(tw*th);
Â Â Â Â Â Â for(let i=0;i<tw*th;i++){
Â Â Â Â Â Â Â Â const r=imgd.data[i*4],g=imgd.data[i*4+1],b=imgd.data[i*4+2],a=imgd.data[i*4+3];
Â Â Â Â Â Â Â Â const al=a/255,rr=r*al+255*(1-al),gg=g*al+255*(1-al),bb=b*al+255*(1-al);
Â Â Â Â Â Â Â Â lum[i]=0.2126*rr+0.7152*gg+0.0722*bb;
Â Â Â Â Â Â }
Â Â Â Â Â Â // 3-bin split at 33rd and 66th percentile
Â Â Â Â Â Â const sorted=Float32Array.from(lum).sort();
Â Â Â Â Â Â const t1=sorted[Math.floor(sorted.length/3)];
Â Â Â Â Â Â const t2=sorted[Math.floor(2*sorted.length/3)];
Â Â Â Â Â Â const pixels=[];
Â Â Â Â Â Â for(let y=0;y<th;y++){
Â Â Â Â Â Â Â Â const row=[];
Â Â Â Â Â Â Â Â for(let x=0;x<tw;x++){const l=lum[y*tw+x];row.push(l<t1?0:l<t2?1:2);}
Â Â Â Â Â Â Â Â pixels.push(row);
Â Â Â Â Â Â }
Â Â Â Â Â Â gPixels={w:tw,h:th,pixels};
Â Â Â Â Â Â document.getElementById('pixPanel').style.display='';
Â Â Â Â Â Â document.getElementById('pixCount').textContent=(tw*th).toLocaleString();
Â Â Â Â Â Â document.getElementById('pixW').textContent=tw;
Â Â Â Â Â Â document.getElementById('pixH').textContent=th;
Â Â Â Â Â Â if(gMode==='pixel'){setStat('A',tw*th);setStat('B',tw);setStat('C',th);}
Â Â Â Â Â Â drawPixelPreview();
Â Â Â Â Â Â toast(`Preview: ${tw}Ã—${th} pixels, 3 shades`);
Â Â Â Â };
Â Â Â Â img.src=ev.target.result;
Â Â };
Â Â reader.readAsDataURL(file);
}

function drawPixelPreview(){
Â Â if(!gPixels){pCtx.clearRect(0,0,270,270);return;}
Â Â const{w,h,pixels}=gPixels;
Â Â const scale=Math.min(270/w,270/h);
Â Â const pw=Math.floor(scale*w),ph=Math.floor(scale*h);
Â Â const dark=document.documentElement.getAttribute('data-theme')==='dark';
Â Â pCtx.fillStyle=dark?'#08090f':'#f0f2f8';pCtx.fillRect(0,0,270,270);
Â Â for(let y=0;y<h;y++){
Â Â Â Â for(let x=0;x<w;x++){
Â Â Â Â Â Â pCtx.fillStyle=BIN_CLR[pixels[y][x]];
Â Â Â Â Â Â pCtx.fillRect(
Â Â Â Â Â Â Â Â Math.round(x*scale+(270-pw)/2),
Â Â Â Â Â Â Â Â Math.round(y*scale+(270-ph)/2),
Â Â Â Â Â Â Â Â Math.ceil(scale),Math.ceil(scale)
Â Â Â Â Â Â );
Â Â Â Â }
Â Â }
}

function buildPixelLines(){
Â Â if(!gPixels)return null;
Â Â const sp=+document.getElementById('pixelSpacing').value||1;
Â Â const use4x=document.getElementById('use4x').checked,bs=use4x?4:1;
Â Â const ox=+document.getElementById('offsetX').value||0;
Â Â const oy=+document.getElementById('offsetY').value||0;
Â Â const oz=+document.getElementById('offsetZ').value||0;
Â Â const ids=[
Â Â Â Â +document.getElementById('idBin0').value||5,
Â Â Â Â +document.getElementById('idBin1').value||25,
Â Â Â Â +document.getElementById('idBin2').value||52,
Â Â ];
Â Â const{w,h,pixels}=gPixels;
Â Â const pxLines=[];
Â Â for(let py=0;py<h;py++)for(let px=0;px<w;px++){
Â Â Â Â const id=ids[pixels[py][px]];
Â Â Â Â const mx=ox+px*sp*bs,mz=oz+py*sp*bs;
Â Â Â Â for(let z=mz;z<mz+bs;z++)pxLines.push({id,rot:0,points:line3D(mx,oy,z,mx+(bs-1),oy,z)});
Â Â }
Â Â return pxLines;
}

async function generatePixel(){
Â Â if(!gPixels){toast('Preview an image first (Step 1)');return;}
Â Â const pxLines=buildPixelLines();
Â Â if(!pxLines?.length){toast('No pixel data to generate');return;}
Â Â log('Compressingâ€¦','warn');dbg('=== Pixel Generate ===');
Â Â try{
Â Â Â Â const code=await encodeTrack(pxLines,
Â Â Â Â Â Â document.getElementById('pixelTrackName').value||'Pixel Art',
Â Â Â Â Â Â document.getElementById('pixelAuthor').value||'Builder');
Â Â Â Â emitCode(code);
Â Â Â Â setStat('A',gPixels.w*gPixels.h);setStat('B',gPixels.w);setStat('C',gPixels.h);
Â Â Â Â toast('Pixel art track generated!');
Â Â }catch(e){dbg('ERROR: '+e.message,'err');log(e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HILL INSERTER â€” verified from 4-direction test track
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// CONFIRMED block layout (travel -Z, starting from flat at z=0):
//Â Â Â z= -8Â Â y=0Â Â ID145 rot=0Â Â Â â† entry transition (0%â†’slope), 4-unit footprint
//Â Â Â z=-16Â Â y=2Â Â ID146 rot=2Â Â Â â† main 45Â° ramp, 8-unit footprint, y+2
//Â Â Â [PEAK at z=-20, y=4]
//Â Â Â z=-28Â Â y=2Â Â ID146 rot=0Â Â Â â† descending ramp (mirror)
//Â Â Â z=-36Â Â y=0Â Â ID145 rot=2Â Â Â â† exit transition (slopeâ†’0%)
//
// CONFIRMED rotation table (all 4 directions, directly from decode):
//Â Â Â Travel -Z:Â Â ID145 rot=0, ID146 rot=2Â Â Â (desc: ID146 rot=0, ID145 rot=2)
//Â Â Â Travel +Z:Â Â ID145 rot=2, ID146 rot=0Â Â Â (desc: ID146 rot=2, ID145 rot=0)
//Â Â Â Travel -X:Â Â ID145 rot=1, ID146 rot=3Â Â Â (desc: ID146 rot=1, ID145 rot=3)
//Â Â Â Travel +X:Â Â ID145 rot=3, ID146 rot=1Â Â Â (desc: ID146 rot=3, ID145 rot=1)
//
// Pattern: ascending ID145 rot = travel cardinal (0=-Z,1=-X,2=+Z,3=+X)
//Â Â Â Â Â Â Â Â Â Â ascending ID146 rot = (ID145 rot + 2) % 4
//Â Â Â Â Â Â Â Â Â Â descending is the exact mirror: swap ID145â†”ID146 rots
//
// Step sizes: ID145 = 8 coord units from start, ID146 = 8 more = 16 from start
// Each coord unit = 5m real world â†’ ID145 at 40m, ID146 at 80m, peak at 100m

// Cardinal 0=angle 0Â°(+Z), 1=90Â°(+X), 2=180Â°(-Z), 3=270Â°(-X)
// but we need travel direction, not compass angle
// Angleâ†’cardinal: 0Â°â†’+Z(idx2 below), 90Â°â†’+X(idx3), 180Â°â†’-Z(idx0), 270Â°â†’-X(idx1)
const HILL_CARDINALS = [
Â Â // idx 0: travel -Z (angle 180Â°)
Â Â { label:'-Z', dx: 0, dz:-1,
Â Â Â Â asc145rot:0, asc146rot:2,
Â Â Â Â dsc146rot:0, dsc145rot:2 },
Â Â // idx 1: travel -X (angle 270Â°)
Â Â { label:'-X', dx:-1, dz: 0,
Â Â Â Â asc145rot:1, asc146rot:3,
Â Â Â Â dsc146rot:1, dsc145rot:3 },
Â Â // idx 2: travel +Z (angle 0Â°)
Â Â { label:'+Z', dx: 0, dz: 1,
Â Â Â Â asc145rot:2, asc146rot:0,
Â Â Â Â dsc146rot:2, dsc145rot:0 },
Â Â // idx 3: travel +X (angle 90Â°)
Â Â { label:'+X', dx: 1, dz: 0,
Â Â Â Â asc145rot:3, asc146rot:1,
Â Â Â Â dsc146rot:3, dsc145rot:1 },
];

// Angle 0Â°=+Z â†’ cardinal idx 2; 90Â°=+X â†’ idx 3; 180Â°=-Z â†’ idx 0; 270Â°=-X â†’ idx 1
function angleToCardinal(deg) {
Â Â const norm = ((deg % 360) + 360) % 360;
Â Â // Map: 0Â°â†’+Z(2), 90Â°â†’+X(3), 180Â°â†’-Z(0), 270Â°â†’-X(1)
Â Â const snap = Math.round(norm / 90) % 4; // 0,1,2,3 for 0Â°,90Â°,180Â°,270Â°
Â Â return [2, 3, 0, 1][snap];
}

function syncHillAngle(val) {
Â Â const v = Math.max(0, Math.min(359, +val || 0));
Â Â document.getElementById('hillAngle').value = v;
Â Â document.getElementById('hillAngleTxt').value = v;
Â Â updateHillPreview(v);
}
function updateHillPreview(deg) {
Â Â const c = angleToCardinal(deg);
Â Â const h = HILL_CARDINALS[c];
Â Â const snapAngle = [180, 270, 0, 90][c]; // cardinal idxâ†’angle
Â Â document.getElementById('hillRotInfo').innerHTML =
Â Â Â Â `Snapped to <b>${h.label}</b> (${snapAngle}Â°)<br>` +
Â Â Â Â `Ascend: ID145 rot=<b>${h.asc145rot}</b> â†’ ID146 rot=<b>${h.asc146rot}</b><br>` +
Â Â Â Â `Descend: ID146 rot=<b>${h.dsc146rot}</b> â†’ ID145 rot=<b>${h.dsc145rot}</b>`;
Â Â drawHillDiagram(deg, c);
}

function drawHillDiagram(deg, cardinal) {
Â Â const cvs = document.getElementById('hillCanvas');
Â Â const ctx = cvs.getContext('2d');
Â Â const W = 240, H = 160;
Â Â ctx.clearRect(0, 0, W, H);
Â Â const dark = document.documentElement.getAttribute('data-theme') === 'dark';
Â Â ctx.fillStyle = dark ? '#161c2d' : '#f0f2f8';
Â Â ctx.fillRect(0, 0, W, H);
Â Â const acc = dark ? '#f5a623' : '#c87c08';
Â Â const dim = dark ? '#4e6080' : '#9090b0';
Â Â const grn = dark ? '#3dd68c' : '#1d9e5e';
Â Â const cyn = dark ? '#39c8e0' : '#1899b8';
Â Â const h = HILL_CARDINALS[cardinal];

Â Â // â”€â”€ Compass (top half) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Â Â const cx = W/2, cy = 68;
Â Â ctx.strokeStyle = dark?'#1e2840':'#dde2ef'; ctx.lineWidth=1;
Â Â for(let a=0;a<360;a+=45){
Â Â Â Â const r=(a-90)*Math.PI/180;
Â Â Â Â ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(r)*52,cy+Math.sin(r)*52);ctx.stroke();
Â Â }
Â Â ctx.strokeStyle=dark?'#2a3a58':'#c4cce0';
Â Â ctx.beginPath();ctx.arc(cx,cy,52,0,Math.PI*2);ctx.stroke();
Â Â ctx.font='bold 8px "JetBrains Mono",monospace';
Â Â ctx.fillStyle=dim;ctx.textAlign='center';ctx.textBaseline='middle';
Â Â ctx.fillText('+Z',cx,cy-63);ctx.fillText('-Z',cx,cy+63);
Â Â ctx.fillText('+X',cx+63,cy);ctx.fillText('-X',cx-63,cy);

Â Â // Dashed actual angle
Â Â const norm=((deg%360)+360)%360, snapDeg=cardinal*90;
Â Â if(Math.abs(norm-snapDeg)>2){
Â Â Â Â const rr=(norm-90)*Math.PI/180;
Â Â Â Â ctx.strokeStyle=dim;ctx.lineWidth=1;ctx.setLineDash([3,3]);
Â Â Â Â ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(rr)*44,cy+Math.sin(rr)*44);ctx.stroke();
Â Â Â Â ctx.setLineDash([]);
Â Â }
Â Â // Solid snapped arrow
Â Â const sr=(snapDeg-90)*Math.PI/180;
Â Â const ax=cx+Math.cos(sr)*46,ay=cy+Math.sin(sr)*46;
Â Â ctx.shadowColor=acc;ctx.shadowBlur=8;
Â Â ctx.strokeStyle=acc;ctx.lineWidth=2.5;ctx.lineCap='round';
Â Â ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(ax,ay);ctx.stroke();
Â Â const hl=9,hr=Math.PI/6;
Â Â ctx.fillStyle=acc;ctx.beginPath();
Â Â ctx.moveTo(ax,ay);
Â Â ctx.lineTo(ax-hl*Math.cos(sr-hr),ay-hl*Math.sin(sr-hr));
Â Â ctx.lineTo(ax-hl*Math.cos(sr+hr),ay-hl*Math.sin(sr+hr));
Â Â ctx.closePath();ctx.fill();ctx.shadowBlur=0;
Â Â ctx.fillStyle=acc;ctx.shadowColor=acc;ctx.shadowBlur=5;
Â Â ctx.beginPath();ctx.arc(cx,cy,3,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;

Â Â // â”€â”€ Cross-section profile (bottom half) â”€â”€
Â Â // Proportional to real units: entry=4, ramp=8, ramp=8, entry=4 = 24 total
Â Â const bY=H-16, bX=10, bW=W-20, sc=bW/24;
Â Â // Ground line
Â Â ctx.strokeStyle=dim;ctx.lineWidth=1;
Â Â ctx.beginPath();ctx.moveTo(bX,bY);ctx.lineTo(bX+bW,bY);ctx.stroke();
Â Â // Filled profile
Â Â // Points: x in proportion to Z units, y scaled (max y=4 â†’ 28px tall)
Â Â const Ys=28/4; // pixels per Y unit
Â Â const profile=[
Â Â Â Â [0,0],[4,0],[12,2],[12,2],[20,2],[24,0]
Â Â ];
Â Â ctx.fillStyle=dark?'rgba(245,166,35,.07)':'rgba(200,124,8,.07)';
Â Â ctx.beginPath();ctx.moveTo(bX,bY);
Â Â for(const[u,y]of profile)ctx.lineTo(bX+u*sc,bY-y*Ys);
Â Â ctx.lineTo(bX+bW,bY);ctx.closePath();ctx.fill();
Â Â // Outline
Â Â ctx.strokeStyle=acc;ctx.lineWidth=2;ctx.lineJoin='round';
Â Â ctx.beginPath();ctx.moveTo(bX,bY);
Â Â for(const[u,y]of profile)ctx.lineTo(bX+u*sc,bY-y*Ys);
Â Â ctx.lineTo(bX+bW,bY);ctx.stroke();
Â Â // Dividers
Â Â ctx.strokeStyle=dark?'rgba(255,255,255,.12)':'rgba(0,0,0,.1)';
Â Â ctx.lineWidth=1;ctx.setLineDash([2,2]);
Â Â for(const u of[4,12,20]){ctx.beginPath();ctx.moveTo(bX+u*sc,bY);ctx.lineTo(bX+u*sc,bY-50);ctx.stroke();}
Â Â ctx.setLineDash([]);
Â Â // Segment labels
Â Â ctx.font='7px "JetBrains Mono",monospace';ctx.textAlign='center';ctx.textBaseline='top';
Â Â const segs=[
Â Â Â Â {mid:2,Â Â y:0,Â Â label:`145\nr=${h.asc145rot}`, col:grn},
Â Â Â Â {mid:8,Â Â y:2,Â Â label:`146\nr=${h.asc146rot}`,Â Â col:acc},
Â Â Â Â {mid:16, y:2,Â Â label:`146\nr=${h.dsc146rot}`,Â Â col:acc},
Â Â Â Â {mid:22, y:0,Â Â label:`145\nr=${h.dsc145rot}`, col:grn},
Â Â ];
Â Â for(const s of segs){
Â Â Â Â const lx=bX+s.mid*sc, ly=bY-s.y*Ys-22;
Â Â Â Â ctx.fillStyle=s.col;
Â Â Â Â s.label.split('\n').forEach((ln,i)=>ctx.fillText(ln,lx,ly+i*9));
Â Â }
Â Â // Height annotation
Â Â ctx.fillStyle=cyn;ctx.textAlign='left';
Â Â ctx.fillText('y+4',bX+12*sc+3,bY-4*Ys);
}

function addHill() {
Â Â const degÂ Â Â = +document.getElementById('hillAngleTxt').value || 0;
Â Â const bxÂ Â Â Â = +document.getElementById('hillX').value || 0;
Â Â const byÂ Â Â Â = +document.getElementById('hillY').value || 0;
Â Â const bzÂ Â Â Â = +document.getElementById('hillZ').value || 0;
Â Â const width = Math.max(1, +document.getElementById('hillWidth').value || 1);

Â Â const c = angleToCardinal(deg);
Â Â const h = HILL_CARDINALS[c];
Â Â const snapAngle = [180, 270, 0, 90][c];

Â Â // Width lanes spread perpendicular to the travel direction
Â Â const isZAxis = (h.dx === 0);
Â Â const halfW = Math.floor(width / 2);

Â Â for (let w = 0; w < width; w++) {
Â Â Â Â const wOff = (w - halfW) * 4;
Â Â Â Â const wx = bx + (isZAxis ? wOff : 0);
Â Â Â Â const wz = bz + (isZAxis ? 0 : wOff);

Â Â Â Â // Distances confirmed from 4-direction decode:
Â Â Â Â //Â Â Â ID145 (entry)Â Â atÂ Â 8 units from base, y=+0
Â Â Â Â //Â Â Â ID146 (ramp)Â Â Â at 16 units from base, y=+2
Â Â Â Â //Â Â Â ID146 (ramp)Â Â Â at 24 units from base, y=+2Â Â (descending mirror)
Â Â Â Â //Â Â Â ID145 (entry)Â Â at 32 units from base, y=+0Â Â (exit)
Â Â Â Â gLines.push({ id:145, rot:h.asc145rot, points:[{ x:wx+h.dx*8,Â Â y:by,Â Â Â z:wz+h.dz*8Â Â }] });
Â Â Â Â gLines.push({ id:146, rot:h.asc146rot, points:[{ x:wx+h.dx*16, y:by+2, z:wz+h.dz*16 }] });
Â Â Â Â gLines.push({ id:146, rot:h.dsc146rot, points:[{ x:wx+h.dx*24, y:by+2, z:wz+h.dz*24 }] });
Â Â Â Â gLines.push({ id:145, rot:h.dsc145rot, points:[{ x:wx+h.dx*32, y:by,Â Â Â z:wz+h.dz*32 }] });
Â Â }

Â Â refreshShapeUI();
Â Â toast(`Hill added â†’ ${h.label} (snapped to ${snapAngle}Â°), width ${width}`);
Â Â dbg(`Hill: dir=${h.label} rots=${h.asc145rot},${h.asc146rot},${h.dsc146rot},${h.dsc145rot} base=(${bx},${by},${bz}) w=${width}`, 'ok');
}

document.getElementById('tab-shape').addEventListener('click', () => {
Â Â setTimeout(() => updateHillPreview(+document.getElementById('hillAngleTxt').value || 0), 50);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
switchMode('kml');
</script>

</body>
</html>
