<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PolyTrack Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #07090f;
  --surf:    #0d1118;
  --panel:   #111620;
  --border:  #1c2333;
  --border2: #263044;
  --accent:  #f5a623;
  --accentd: #c27d0e;
  --cyan:    #39c8e0;
  --green:   #39e08c;
  --red:     #e03939;
  --muted:   #4a5878;
  --dim:     #2a3550;
  --text:    #c0ceee;
  --bright:  #eef2ff;
  --glow:    rgba(245,166,35,.2);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

body{
font-family:â€˜Rajdhaniâ€™,sans-serif;
background:var(â€“bg);
color:var(â€“text);
min-height:100vh;
overflow-x:hidden;
}
body::before{
content:â€™â€™;position:fixed;inset:0;
background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.05) 2px,rgba(0,0,0,.05) 4px);
pointer-events:none;z-index:9999;
}

/* â”€â”€ Topbar â”€â”€ */
.topbar{
display:flex;align-items:center;justify-content:space-between;
padding:0 1.75rem;height:52px;
background:var(â€“surf);border-bottom:1px solid var(â€“border);
position:sticky;top:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:.75rem}
.logo-mark{
width:28px;height:28px;background:var(â€“accent);
clip-path:polygon(50% 0%,100% 38%,82% 100%,18% 100%,0% 38%);
box-shadow:0 0 14px var(â€“glow);flex-shrink:0;
}
.logo h1{font-size:1.15rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(â€“bright)}
.logo h1 span{color:var(â€“accent)}
.topbar-right{display:flex;align-items:center;gap:1rem}
.topbar-stat{
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.6rem;
color:var(â€“muted);letter-spacing:1px;text-align:right;line-height:1.6;
}

/* â”€â”€ Mode selector â”€â”€ */
.mode-bar{
display:flex;background:var(â€“surf);border-bottom:1px solid var(â€“border);
padding:0 1.75rem;
}
.mode-btn{
padding:.7rem 1.4rem;
font-family:â€˜Rajdhaniâ€™,sans-serif;font-weight:700;font-size:.72rem;
letter-spacing:2.5px;text-transform:uppercase;
color:var(â€“muted);cursor:pointer;border-bottom:2px solid transparent;
transition:all .15s;white-space:nowrap;
}
.mode-btn:hover{color:var(â€“text)}
.mode-btn.active{color:var(â€“accent);border-bottom-color:var(â€“accent)}
.mode-badge{
display:inline-block;background:rgba(245,166,35,.12);
border:1px solid rgba(245,166,35,.25);border-radius:3px;
font-size:.55rem;padding:.1rem .35rem;margin-left:.4rem;color:var(â€“accent);
}

/* â”€â”€ Workspace â”€â”€ */
.workspace{display:grid;grid-template-columns:330px 1fr;min-height:calc(100vh - 100px)}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{
background:var(â€“surf);border-right:1px solid var(â€“border);
overflow-y:auto;display:flex;flex-direction:column;
}
.sb-section{border-bottom:1px solid var(â€“border);padding:1.1rem 1.25rem}
.sb-section:last-child{border-bottom:none}
.sb-head{
display:flex;align-items:center;gap:.5rem;margin-bottom:.9rem;
}
.sb-num{
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.55rem;letter-spacing:2px;
color:var(â€“accent);background:rgba(245,166,35,.08);
border:1px solid rgba(245,166,35,.2);padding:.15rem .4rem;border-radius:3px;
}
.sb-title{font-size:.65rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(â€“muted)}

/* â”€â”€ Fields â”€â”€ */
.field{margin-bottom:.7rem}
.field:last-child{margin-bottom:0}
.field>label,.field-label{
display:block;font-size:.62rem;font-weight:600;letter-spacing:2px;
text-transform:uppercase;color:var(â€“muted);margin-bottom:.3rem;
}
input[type=text],input[type=number],select,textarea{
width:100%;padding:.48rem .65rem;
background:var(â€“panel);border:1px solid var(â€“border);border-radius:3px;
color:var(â€“text);font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.78rem;
outline:none;transition:border-color .15s,box-shadow .15s;
}
input:focus,select:focus,textarea:focus{
border-color:var(â€“accent);box-shadow:0 0 0 2px rgba(245,166,35,.1);
}
select option{background:var(â€“panel)}
textarea{resize:vertical;min-height:100px;line-height:1.5}
.coord3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.35rem}
.coord2{display:grid;grid-template-columns:1fr 1fr;gap:.35rem}
.check-label{
display:flex;align-items:center;gap:.5rem;font-size:.75rem;
color:var(â€“text);cursor:pointer;margin-top:.3rem;
}
.check-label input[type=checkbox]{accent-color:var(â€“accent);width:13px;height:13px;flex-shrink:0}
.toggle-row{
display:flex;align-items:center;justify-content:space-between;
padding:.45rem 0;border-bottom:1px solid var(â€“border);
}
.toggle-row label{font-size:.75rem;color:var(â€“text);cursor:pointer}
.toggle-row:last-child{border-bottom:none}
.sep{height:1px;background:var(â€“border);margin:.65rem 0}

/* â”€â”€ Buttons â”€â”€ */
.btn{
display:inline-flex;align-items:center;justify-content:center;gap:.35rem;
padding:.48rem .85rem;border:none;border-radius:3px;cursor:pointer;
font-family:â€˜Rajdhaniâ€™,sans-serif;font-weight:700;font-size:.75rem;
letter-spacing:1.5px;text-transform:uppercase;transition:all .15s;
}
.btn-primary{
background:var(â€“accent);color:#000;
box-shadow:0 0 18px rgba(245,166,35,.22);
}
.btn-primary:hover{background:#ffc04a;box-shadow:0 0 26px rgba(245,166,35,.38)}
.btn-primary:active{transform:scale(.97)}
.btn-primary:disabled{background:var(â€“dim);color:var(â€“muted);box-shadow:none;cursor:not-allowed}
.btn-ghost{background:transparent;color:var(â€“muted);border:1px solid var(â€“border)}
.btn-ghost:hover{color:var(â€“text);border-color:var(â€“border2)}
.btn-danger{background:transparent;color:var(â€“red);border:1px solid rgba(224,57,57,.25)}
.btn-danger:hover{background:rgba(224,57,57,.08)}
.btn-full{width:100%}
.btn-sm{padding:.28rem .55rem;font-size:.65rem}
.btn-row{display:flex;gap:.4rem;margin-top:.65rem;flex-wrap:wrap}
.big-btn{
width:100%;padding:.8rem;font-size:.82rem;letter-spacing:2.5px;
margin-top:.35rem;position:relative;overflow:hidden;
}
.big-btn::after{
content:â€™â€™;position:absolute;inset:0;
background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);
transform:translateX(-100%);transition:transform .45s;
}
.big-btn:hover::after{transform:translateX(100%)}

/* â”€â”€ Main area â”€â”€ */
.main{display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€ Stats bar â”€â”€ */
.stats-bar{
display:flex;gap:1px;background:var(â€“border);
border-bottom:1px solid var(â€“border);
}
.stat{
background:var(â€“surf);padding:.75rem 1.1rem;flex:1;
display:flex;flex-direction:column;gap:.2rem;
}
.stat-val{
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:1.15rem;
font-weight:700;color:var(â€“accent);line-height:1;
}
.stat-lbl{font-size:.6rem;color:var(â€“muted);letter-spacing:1.5px;text-transform:uppercase}

/* â”€â”€ Content panels â”€â”€ */
.content{flex:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:1.25rem}

/* â”€â”€ Canvas â”€â”€ */
.canvas-wrap{
background:var(â€“panel);border:1px solid var(â€“border);border-radius:4px;
position:relative;overflow:hidden;
}
.canvas-wrap canvas{display:block;width:100%}
.canvas-overlay{
position:absolute;top:.6rem;right:.75rem;
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.6rem;
color:var(â€“muted);letter-spacing:1px;
}

/* â”€â”€ Output panel â”€â”€ */
.out-panel{background:var(â€“panel);border:1px solid var(â€“border);border-radius:4px}
.out-header{
padding:.65rem 1rem;border-bottom:1px solid var(â€“border);
display:flex;justify-content:space-between;align-items:center;
}
.out-label{
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.62rem;
letter-spacing:2px;color:var(â€“muted);text-transform:uppercase;
}
.out-code{
background:#000;padding:.85rem 1rem;
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.7rem;
word-break:break-all;max-height:130px;overflow:auto;
color:var(â€“cyan);line-height:1.6;letter-spacing:.3px;
}
.out-footer{padding:.65rem 1rem;border-top:1px solid var(â€“border);display:flex;gap:.5rem}

/* â”€â”€ Log â”€â”€ */
.log-line{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.7rem;color:var(â€“muted)}
.log-line .ok{color:var(â€“green)}
.log-line .warn{color:var(â€“accent)}
.log-line .err{color:var(â€“red)}

/* â”€â”€ Debug console â”€â”€ */
.debug-panel{border-top:1px solid var(â€“border)}
#debugLog{
background:#000;padding:.65rem 1rem;
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.65rem;
color:#3a5050;line-height:1.9;max-height:190px;overflow-y:auto;
}

/* â”€â”€ Drop zone â”€â”€ */
.drop-zone{
border:2px dashed var(â€“border);border-radius:3px;
padding:1.25rem;text-align:center;cursor:pointer;
transition:all .15s;font-size:.75rem;color:var(â€“muted);
position:relative;
}
.drop-zone.over{border-color:var(â€“accent);background:rgba(245,166,35,.04);color:var(â€“accent)}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.dz-icon{font-size:1.3rem;margin-bottom:.3rem}

/* â”€â”€ Lines list â”€â”€ */
.lines-wrap{max-height:340px;overflow-y:auto;display:flex;flex-direction:column;gap:.35rem}
.line-item{
display:flex;align-items:center;gap:.6rem;
background:var(â€“panel);border:1px solid var(â€“border);border-radius:3px;
padding:.5rem .75rem;transition:border-color .15s;
}
.line-item:hover{border-color:var(â€“border2)}
.line-badge{
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.6rem;font-weight:700;
background:rgba(245,166,35,.08);color:var(â€“accent);
border:1px solid rgba(245,166,35,.2);padding:.15rem .4rem;border-radius:3px;
min-width:40px;text-align:center;flex-shrink:0;
}
.line-info{flex:1;font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.68rem;color:var(â€“text);min-width:0}
.line-name{font-size:.6rem;color:var(â€“accent);margin-bottom:.1rem}
.line-coords{font-size:.58rem;color:var(â€“muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.empty-state{text-align:center;padding:2.5rem 1rem;color:var(â€“muted)}
.empty-icon{font-size:2rem;opacity:.2;margin-bottom:.5rem}
.empty-state p{font-size:.75rem;letter-spacing:1px}

/* â”€â”€ Info box â”€â”€ */
.info-box{
background:rgba(245,166,35,.04);border:1px solid rgba(245,166,35,.12);
border-left:3px solid var(â€“accent);border-radius:3px;
padding:.6rem .85rem;font-size:.72rem;color:var(â€“muted);line-height:1.7;
}
.info-box b{color:var(â€“accent)}

/* â”€â”€ Pixel art â”€â”€ */
.px-layout{display:grid;grid-template-columns:1fr 310px;gap:1.25rem}
.preview-wrap{
background:var(â€“panel);border:1px solid var(â€“border);border-radius:4px;overflow:hidden;
}
.preview-wrap canvas{display:block;width:100%}
.legend-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.35rem}
.swatch{width:16px;height:16px;border-radius:2px;flex-shrink:0}
.id-input-sm{
width:60px!important;text-align:center;padding:.28rem .4rem!important;font-size:.75rem!important;
}

/* â”€â”€ Toast â”€â”€ */
.toast{
position:fixed;bottom:1.75rem;right:1.75rem;
background:var(â€“panel);border:1px solid var(â€“accent);border-radius:4px;
padding:.65rem 1.1rem;font-family:â€˜JetBrains Monoâ€™,monospace;font-size:.72rem;
color:var(â€“accent);letter-spacing:1px;
box-shadow:0 8px 32px rgba(0,0,0,.6),0 0 20px var(â€“glow);z-index:10000;
transform:translateY(80px);opacity:0;transition:all .28s cubic-bezier(.34,1.56,.64,1);
pointer-events:none;
}
.toast.show{transform:translateY(0);opacity:1}

/* â”€â”€ Mode panels (hidden/shown) â”€â”€ */
.mode-panel{display:none}
.mode-panel.active{display:contents}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(â€“dim);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(â€“muted)}

@media(max-width:900px){
.workspace{grid-template-columns:1fr}
.sidebar{border-right:none;border-bottom:1px solid var(â€“border)}
.px-layout{grid-template-columns:1fr}
.stats-bar{flex-wrap:wrap}
}
</style>

</head>
<body>

<!-- â•â• TOPBAR â•â• -->

<div class="topbar">
  <div class="logo">
    <div class="logo-mark"></div>
    <h1>Poly<span>Track</span> Studio</h1>
  </div>
  <div class="topbar-right">
    <div class="topbar-stat" id="globalStat">NO TRACK LOADED</div>
  </div>
</div>

<!-- â•â• MODE BAR â•â• -->

<div class="mode-bar">
  <div class="mode-btn active" onclick="switchMode('kml')">ğŸ—º KML Circuit <span class="mode-badge">1:1 SCALE</span></div>
  <div class="mode-btn" onclick="switchMode('shape')">â—ˆ Shape Builder</div>
  <div class="mode-btn" onclick="switchMode('pixel')">ğŸ¨ Pixel Art</div>
</div>

<!-- â•â• WORKSPACE â•â• -->

<div class="workspace">

<!-- â•â•â•â• SIDEBAR â•â•â•â• -->

<div class="sidebar">

  <!-- â”€â”€ KML mode sidebar â”€â”€ -->

  <div id="sb-kml">
    <div class="sb-section">
      <div class="sb-head"><span class="sb-num">01</span><span class="sb-title">KML Input</span></div>
      <div class="field">
        <label>Paste KML or drop a .kml file</label>
        <textarea id="kmlInput" placeholder="Paste full KML hereâ€¦&#10;Export a path from Google Earth as KML." spellcheck="false"></textarea>
      </div>
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept=".kml,.xml">
        <div class="dz-icon">ğŸ“‚</div>
        <div>Drop .kml / click to browse</div>
      </div>
    </div>

```
<div class="sb-section">
  <div class="sb-head"><span class="sb-num">02</span><span class="sb-title">Track Settings</span></div>
  <div class="field"><label>Track Name</label><input type="text" id="kmlTrackName" value="My Circuit" maxlength="50"></div>
  <div class="field"><label>Author</label><input type="text" id="kmlAuthor" value="Builder" maxlength="50"></div>
  <div class="coord2" style="margin-top:.5rem">
    <div class="field" style="margin:0"><label>Origin X</label><input type="number" id="originX" value="500"></div>
    <div class="field" style="margin:0"><label>Origin Z</label><input type="number" id="originZ" value="500"></div>
  </div>
  <div class="coord2" style="margin-top:.5rem">
    <div class="field" style="margin:0"><label>Base Y</label><input type="number" id="originY" value="0"></div>
    <div class="field" style="margin:0"><label>Road Width</label><input type="number" id="roadWidth" value="1" min="1" max="10"></div>
  </div>
</div>

<div class="sb-section">
  <div class="sb-head"><span class="sb-num">03</span><span class="sb-title">Options</span></div>
  <div class="toggle-row">
    <label for="smoothPath">Smooth path (RDP)</label>
    <input type="checkbox" id="smoothPath" checked>
  </div>
  <div class="field" style="margin-top:.6rem">
    <label>Smoothing tolerance (m)</label>
    <input type="number" id="smoothTol" value="10" min="1" max="200">
  </div>
  <div class="field">
    <label>Checkpoint angle threshold (Â°)</label>
    <input type="number" id="turnAngle" value="20" min="5" max="90">
  </div>
  <div class="toggle-row" style="opacity:.45;pointer-events:none" title="Coming soon â€” slope blocks needed">
    <label>Elevation (Y axis)</label>
    <input type="checkbox" id="useElevation" disabled>
  </div>
  <div style="font-size:.6rem;color:var(--muted);margin-top:.25rem;letter-spacing:.5px">
    âš  Elevation disabled â€” slope blocks not yet engineered
  </div>
</div>

<div class="sb-section">
  <div class="info-box">
    <b>Scale:</b> 1 block = 20Ã—20m Â· 1:1 real world.<br>
    <b>IDs:</b> 92=Start Â· 75=Checkpoint Â· 76=Finish Â· 25=Road<br>
    <b>Tip:</b> Export a path from Google Earth as KML.
  </div>
  <button class="btn btn-primary big-btn" id="kmlGenBtn" onclick="generateKML()">âš¡ Generate from KML</button>
</div>
```

  </div><!-- /sb-kml -->

  <!-- â”€â”€ Shape mode sidebar â”€â”€ -->

  <div id="sb-shape" style="display:none">
    <div class="sb-section">
      <div class="sb-head"><span class="sb-num">01</span><span class="sb-title">Shape Builder</span></div>
      <div class="field">
        <label>Shape Type</label>
        <select id="shapeType">
          <option value="line">Line</option>
          <option value="filledRect">Filled Rectangle</option>
          <option value="hollowCube">Hollow Cube</option>
          <option value="filledCube">Filled Cube</option>
        </select>
      </div>

```
  <!-- Line -->
  <div id="form-line" class="shape-form">
    <div class="field"><label>Block ID</label><input type="number" id="lineId" value="25" min="0" max="255"></div>
    <div class="field"><label>Start (X Â· Y Â· Z)</label>
      <div class="coord3">
        <input type="number" id="lsx" value="0" placeholder="X">
        <input type="number" id="lsy" value="0" placeholder="Y">
        <input type="number" id="lsz" value="0" placeholder="Z">
      </div>
    </div>
    <div class="field"><label>End (X Â· Y Â· Z)</label>
      <div class="coord3">
        <input type="number" id="lex" value="100" placeholder="X">
        <input type="number" id="ley" value="0" placeholder="Y">
        <input type="number" id="lez" value="0" placeholder="Z">
      </div>
    </div>
    <div class="field"><label>Rotation (0â€“3)</label><input type="number" id="lineRot" value="0" min="0" max="3"></div>
  </div>

  <!-- Filled Rect -->
  <div id="form-filledRect" class="shape-form" style="display:none">
    <div class="field"><label>Plane</label>
      <select id="rectPlane">
        <option value="xz">XZ â€” Horizontal</option>
        <option value="xy">XY â€” Vertical</option>
        <option value="yz">YZ â€” Vertical</option>
      </select>
    </div>
    <div class="field"><label id="fixedLabel">Fixed Y</label><input type="number" id="fixedCoord" value="0"></div>
    <div class="coord2">
      <div class="field" style="margin:0"><label id="min1Label">Min X</label><input type="number" id="rectMin1" value="0"></div>
      <div class="field" style="margin:0"><label id="max1Label">Max X</label><input type="number" id="rectMax1" value="100"></div>
    </div>
    <div class="coord2" style="margin-top:.5rem">
      <div class="field" style="margin:0"><label id="min2Label">Min Z</label><input type="number" id="rectMin2" value="0"></div>
      <div class="field" style="margin:0"><label id="max2Label">Max Z</label><input type="number" id="rectMax2" value="100"></div>
    </div>
    <div class="coord2" style="margin-top:.5rem">
      <div class="field" style="margin:0"><label>Block ID</label><input type="number" id="rectId" value="25"></div>
      <div class="field" style="margin:0"><label>Rotation</label><input type="number" id="rectRot" value="0" min="0" max="3"></div>
    </div>
  </div>

  <!-- Hollow Cube -->
  <div id="form-hollowCube" class="shape-form" style="display:none">
    <div class="field"><label>Min (X Â· Y Â· Z)</label>
      <div class="coord3">
        <input type="number" id="hcMinX" value="0"><input type="number" id="hcMinY" value="0"><input type="number" id="hcMinZ" value="0">
      </div>
    </div>
    <div class="field"><label>Max (X Â· Y Â· Z)</label>
      <div class="coord3">
        <input type="number" id="hcMaxX" value="100"><input type="number" id="hcMaxY" value="100"><input type="number" id="hcMaxZ" value="100">
      </div>
    </div>
    <div class="coord2" style="margin-top:.5rem">
      <div class="field" style="margin:0"><label>Block ID</label><input type="number" id="hcId" value="25"></div>
      <div class="field" style="margin:0"><label>Rotation</label><input type="number" id="hcRot" value="0" min="0" max="3"></div>
    </div>
  </div>

  <!-- Filled Cube -->
  <div id="form-filledCube" class="shape-form" style="display:none">
    <div class="field"><label>Min (X Â· Y Â· Z)</label>
      <div class="coord3">
        <input type="number" id="fcMinX" value="0"><input type="number" id="fcMinY" value="0"><input type="number" id="fcMinZ" value="0">
      </div>
    </div>
    <div class="field"><label>Max (X Â· Y Â· Z)</label>
      <div class="coord3">
        <input type="number" id="fcMaxX" value="100"><input type="number" id="fcMaxY" value="100"><input type="number" id="fcMaxZ" value="100">
      </div>
    </div>
    <div class="coord2" style="margin-top:.5rem">
      <div class="field" style="margin:0"><label>Block ID</label><input type="number" id="fcId" value="25"></div>
      <div class="field" style="margin:0"><label>Rotation</label><input type="number" id="fcRot" value="0" min="0" max="3"></div>
    </div>
  </div>

  <button class="btn btn-primary btn-full" onclick="addShape()" style="margin-top:.6rem">+ Add Shape</button>
</div>

<div class="sb-section">
  <div class="sb-head"><span class="sb-num">02</span><span class="sb-title">Track Settings</span></div>
  <div class="field"><label>Track Name</label><input type="text" id="shapeTrackName" value="My Track" maxlength="50"></div>
  <div class="field"><label>Author</label><input type="text" id="shapeAuthor" value="Builder" maxlength="50"></div>
  <button class="btn btn-primary big-btn" onclick="generateShape()">âš¡ Generate from Shapes</button>
</div>

<div class="sb-section">
  <div class="sb-head"><span class="sb-num">03</span><span class="sb-title">Procedural</span></div>
  <div class="coord2">
    <div class="field" style="margin:0"><label>Min ID</label><input type="number" id="minId" value="1" min="0" max="255"></div>
    <div class="field" style="margin:0"><label>Max ID</label><input type="number" id="maxId" value="50" min="0" max="255"></div>
  </div>
  <div class="btn-row">
    <button class="btn btn-ghost" onclick="generateTestTrack()">ID Test Track</button>
    <button class="btn btn-danger" onclick="clearLines()">Clear All</button>
  </div>
</div>
```

  </div><!-- /sb-shape -->

  <!-- â”€â”€ Pixel mode sidebar â”€â”€ -->

  <div id="sb-pixel" style="display:none">
    <div class="sb-section">
      <div class="sb-head"><span class="sb-num">01</span><span class="sb-title">Image</span></div>
      <div class="field"><label>Upload PNG / JPEG</label><input type="file" id="imgUpload" accept="image/*"></div>
      <div class="coord2">
        <div class="field" style="margin:0"><label>Resolution</label><input type="number" id="resValue" value="128" min="8" max="512"></div>
        <div class="field" style="margin:0"><label>Spacing</label><input type="number" id="pixelSpacing" value="1" min="1" max="10"></div>
      </div>
      <label class="check-label"><input type="checkbox" id="preserveAspect" checked> Preserve aspect ratio</label>
      <label class="check-label"><input type="checkbox" id="use4x" checked> 4Ã— PolyTrack block scale</label>
    </div>

```
<div class="sb-section">
  <div class="sb-head"><span class="sb-num">02</span><span class="sb-title">Offset</span></div>
  <div class="field"><label>Position (X Â· Y Â· Z)</label>
    <div class="coord3">
      <input type="number" id="offsetX" value="0" placeholder="X">
      <input type="number" id="offsetY" value="0" placeholder="Y">
      <input type="number" id="offsetZ" value="0" placeholder="Z">
    </div>
  </div>
</div>

<div class="sb-section">
  <div class="sb-head"><span class="sb-num">03</span><span class="sb-title">ID Mapping</span></div>
  <div class="legend-row"><div class="swatch" style="background:#3060ff"></div><span style="font-size:.7rem;color:var(--muted);width:80px;flex-shrink:0">Darkest â†’</span><input type="number" class="id-input-sm" id="idBin0" value="5" min="0" max="255"></div>
  <div class="legend-row"><div class="swatch" style="background:#b02020"></div><span style="font-size:.7rem;color:var(--muted);width:80px;flex-shrink:0">Dark â†’</span><input type="number" class="id-input-sm" id="idBin1" value="6" min="0" max="255"></div>
  <div class="legend-row"><div class="swatch" style="background:#b09010"></div><span style="font-size:.7rem;color:var(--muted);width:80px;flex-shrink:0">Light â†’</span><input type="number" class="id-input-sm" id="idBin2" value="52" min="0" max="255"></div>
  <div class="legend-row"><div class="swatch" style="background:#ccd0ee"></div><span style="font-size:.7rem;color:var(--muted);width:80px;flex-shrink:0">Brightest â†’</span><input type="number" class="id-input-sm" id="idBin3" value="0" min="0" max="255"><span style="font-size:.58rem;color:var(--muted);margin-left:.3rem">(0=rnd)</span></div>
</div>

<div class="sb-section">
  <div class="sb-head"><span class="sb-num">04</span><span class="sb-title">Track Settings</span></div>
  <div class="field"><label>Track Name</label><input type="text" id="pixelTrackName" value="Pixel Art" maxlength="50"></div>
  <div class="field"><label>Author</label><input type="text" id="pixelAuthor" value="Builder" maxlength="50"></div>
  <div class="btn-row">
    <button class="btn btn-ghost" onclick="processUpload()">Preview</button>
    <button class="btn btn-ghost" onclick="addPixelToLines()">â†’ Shapes</button>
  </div>
  <button class="btn btn-primary big-btn" onclick="generatePixel()">âš¡ Generate from Pixel Art</button>
</div>
```

  </div><!-- /sb-pixel -->

</div><!-- /sidebar -->

<!-- â•â•â•â• MAIN â•â•â•â• -->

<div class="main">

  <!-- Stats bar -->

  <div class="stats-bar">
    <div class="stat"><div class="stat-val" id="statA">â€”</div><div class="stat-lbl" id="statAL">KML Points</div></div>
    <div class="stat"><div class="stat-val" id="statB">â€”</div><div class="stat-lbl" id="statBL">Road Blocks</div></div>
    <div class="stat"><div class="stat-val" id="statC">â€”</div><div class="stat-lbl" id="statCL">Checkpoints</div></div>
    <div class="stat"><div class="stat-val" id="statD">â€”</div><div class="stat-lbl" id="statDL">Circuit Length</div></div>
    <div class="stat"><div class="stat-val" id="statE">â€”</div><div class="stat-lbl">Code Size</div></div>
  </div>

  <!-- Content area -->

  <div class="content">

```
<!-- KML preview canvas (always present, hidden when not in kml mode) -->
<div class="canvas-wrap" id="kmlCanvasWrap">
  <canvas id="kmlCanvas" height="320"></canvas>
  <div class="canvas-overlay" id="canvasInfo">NO TRACK LOADED</div>
</div>

<!-- Shape lines panel -->
<div class="out-panel" id="linesPanel" style="display:none">
  <div class="out-header">
    <span class="out-label">Track Lines</span>
    <span style="font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--muted)" id="linesCountLabel">0 lines</span>
  </div>
  <div style="padding:.75rem 1rem">
    <div class="lines-wrap" id="linesList">
      <div class="empty-state"><div class="empty-icon">â—ˆ</div><p>No shapes added yet.</p></div>
    </div>
  </div>
  <div class="out-footer">
    <button class="btn btn-ghost btn-sm" onclick="downloadLinesJSON()">Export JSON</button>
    <button class="btn btn-danger btn-sm" onclick="clearLines()">Clear All</button>
  </div>
</div>

<!-- Pixel art preview -->
<div id="pixelPanel" style="display:none">
  <div class="px-layout">
    <div>
      <div style="font-size:.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:.5rem">Statistics</div>
      <div style="display:flex;gap:.65rem;margin-bottom:1rem">
        <div class="stat" style="border:1px solid var(--border);border-radius:3px;flex:0 0 auto;padding:.6rem .9rem">
          <div class="stat-val" id="pixCount" style="font-size:.95rem">0</div><div class="stat-lbl">Pixels</div>
        </div>
        <div class="stat" style="border:1px solid var(--border);border-radius:3px;flex:0 0 auto;padding:.6rem .9rem">
          <div class="stat-val" id="uniqueIDs" style="font-size:.95rem">0</div><div class="stat-lbl">Unique IDs</div>
        </div>
      </div>
      <div class="info-box">
        <b>Bins:</b> quartile-based luminance mapping.<br>
        <b>Brightest ID=0</b> â†’ picks a random ID not used by others.<br>
        <b>â†’ Shapes</b> adds pixels to the shared lines list so you can combine with manual shapes before generating.
      </div>
    </div>
    <div>
      <div style="font-size:.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:.4rem">Preview</div>
      <div class="preview-wrap"><canvas id="previewCanvas" width="310" height="310"></canvas></div>
    </div>
  </div>
</div>

<!-- Output -->
<div class="out-panel">
  <div class="out-header">
    <span class="out-label">Track Code</span>
    <span class="log-line" id="logBox"></span>
  </div>
  <div class="out-code" id="outputCode">Generate a track to see the PolyTrack code hereâ€¦</div>
  <div class="out-footer">
    <button class="btn btn-ghost btn-sm" onclick="copyCode()">Copy</button>
    <button class="btn btn-ghost btn-sm" onclick="downloadCode()">Download .txt</button>
  </div>
</div>

<!-- Debug console -->
<div class="out-panel">
  <div class="out-header" style="cursor:pointer" onclick="toggleDebug()">
    <span class="out-label">Debug Console</span>
    <span id="debugToggle" style="font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--muted)">â–¶ expand</span>
  </div>
  <div class="debug-panel" id="debugPanel" style="display:none">
    <div id="debugLog"></div>
    <div style="padding:.4rem .85rem;border-top:1px solid var(--border)">
      <button class="btn btn-ghost btn-sm" onclick="clearDebug()">Clear</button>
    </div>
  </div>
</div>
```

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /workspace -->

<div class="toast" id="toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ SHARED STATE & UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
let lines = [];          // shape builder lines
let previewPixels = null;
let lastSeed = 0;
let currentMode = 'kml';
let lastGeneratedCode = '';

const ID_NAMES = {5:'Start(old)',6:'Finish(old)',25:'Road',52:'CP',75:'Checkpoint',76:'Finish',92:'Start'};

// â”€â”€ Toast â”€â”€
let _toastTimer;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_toastTimer);_toastTimer=setTimeout(()=>el.classList.remove('show'),2400);
}

// â”€â”€ Log â”€â”€
function log(msg,cls=''){
  document.getElementById('logBox').innerHTML=`<span class="${cls}">${msg}</span>`;
}

// â”€â”€ Debug â”€â”€
const _dbgLines=[];
function dbg(msg,cls=''){
  const ts=new Date().toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  _dbgLines.push({ts,msg,cls});
  if(_dbgLines.length>200)_dbgLines.shift();
  const el=document.getElementById('debugLog');
  if(!el)return;
  const C={err:'#e03939',warn:'#f5a623',ok:'#39e08c','':'#3a6060'};
  el.innerHTML=_dbgLines.map(l=>`<div style="color:${C[l.cls]||C['']}">[${l.ts}] ${l.msg}</div>`).join('');
  el.scrollTop=el.scrollHeight;
}
function clearDebug(){_dbgLines.length=0;const el=document.getElementById('debugLog');if(el)el.innerHTML='';}
function toggleDebug(){
  const p=document.getElementById('debugPanel'),t=document.getElementById('debugToggle');
  const open=p.style.display==='none';p.style.display=open?'':'none';
  t.textContent=open?'â–¼ collapse':'â–¶ expand';
}

// â”€â”€ Mode switching â”€â”€
function switchMode(mode){
  currentMode=mode;
  document.querySelectorAll('.mode-btn').forEach((b,i)=>b.classList.toggle('active',['kml','shape','pixel'][i]===mode));
  ['kml','shape','pixel'].forEach(m=>{
    document.getElementById('sb-'+m).style.display=m===mode?'':'none';
  });
  // Show/hide content panels
  document.getElementById('kmlCanvasWrap').style.display=mode==='kml'?'':'none';
  document.getElementById('linesPanel').style.display=mode==='shape'?'':'none';
  document.getElementById('pixelPanel').style.display=mode==='pixel'?'':'none';
  // Update stat labels
  const labels={
    kml:['KML Points','Road Blocks','Checkpoints','Circuit Length'],
    shape:['Lines','Blocks','Unique IDs','â€”'],
    pixel:['Pixels','Unique IDs','â€”','â€”'],
  };
  const lb=labels[mode];
  ['A','B','C','D'].forEach((l,i)=>{
    document.getElementById('statL'+l).textContent=lb[i];
  });
  if(mode==='shape') updateShapeUI();
}

// â”€â”€ Global stat bar â”€â”€
function setStats(a,b,c,d,e){
  ['A','B','C','D','E'].forEach((l,i)=>{
    const v=[a,b,c,d,e][i];
    document.getElementById('stat'+l).textContent=v??'â€”';
  });
  document.getElementById('globalStat').textContent=`${a||'â€”'} Â· ${b||'â€”'} Â· ${e||'â€”'}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ENCODING (shared)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function zlibCompress(data){
  const cs=new CompressionStream('deflate');
  const w=cs.writable.getWriter();
  w.write(data instanceof Uint8Array?data:new Uint8Array(data));w.close();
  const chunks=[];const reader=cs.readable.getReader();
  for(;;){const{done,value}=await reader.read();if(done)break;chunks.push(value);}
  const len=chunks.reduce((s,c)=>s+c.length,0);
  const out=new Uint8Array(len);let off=0;
  for(const c of chunks){out.set(c,off);off+=c.length;}
  return out;
}

function encode62(buf){
  let bitPos=0,res='';
  while(bitPos<buf.length*8){
    const bi=bitPos>>>3,off=bitPos&7;
    if(bi>=buf.length)break;
    let val;
    if(off<=2||bi>=buf.length-1)val=(buf[bi]>>>off)&63;
    else val=((buf[bi]>>>off)&63)|((buf[bi+1]&(63>>>(8-off)))<<(8-off));
    if((val&30)===30){val&=31;bitPos+=5;}else bitPos+=6;
    res+=CHARS[val];
  }
  return res;
}

function getBytesNeeded(max){return max<128?1:max<32768?2:max<8388608?3:4;}
function writeU32(bin,v){bin.push(v&255,(v>>8)&255,(v>>16)&255,(v>>24)&255);}
function writeCoord(bin,v,bytes){for(let i=0;i<bytes;i++)bin.push((v>>(i*8))&255);}

function buildFromLines(linesList){
  const allPts=linesList.flatMap(l=>l.points);
  if(!allPts.length)return new Uint8Array(0);
  let minX=Infinity,minY=Infinity,minZ=Infinity;
  for(const p of allPts){if(p.x<minX)minX=p.x;if(p.y<minY)minY=p.y;if(p.z<minZ)minZ=p.z;}
  const sx=minX<0?-minX:0,sy=minY<0?-minY:0,sz=minZ<0?-minZ:0;
  let maxX=0,maxY=0,maxZ=0;
  for(const p of allPts){maxX=Math.max(maxX,p.x+sx);maxY=Math.max(maxY,p.y+sy);maxZ=Math.max(maxZ,p.z+sz);}
  const bin=[];
  bin.push(0,0);writeU32(bin,0);writeU32(bin,0);writeU32(bin,0);
  const xB=getBytesNeeded(maxX),yB=getBytesNeeded(maxY),zB=getBytesNeeded(maxZ);
  bin.push((zB<<4)|(yB<<2)|xB);
  dbg(`Binary: max=(${maxX},${maxY},${maxZ}) bytes=(${xB},${yB},${zB}) shift=(${sx},${sy},${sz})`);
  const groups={};
  for(const l of linesList){
    if(!groups[l.id])groups[l.id]=[];
    for(const p of l.points)groups[l.id].push({
      x:p.x+sx,y:p.y+sy,z:p.z+sz,
      rot:l.rot||0,dir:0,color:0,
      cpIndex:p.cpIndex!==undefined?p.cpIndex:(l.cpIndex!==undefined?l.cpIndex:0)
    });
  }
  for(const id of Object.keys(groups).sort((a,b)=>+a-+b)){
    const blocks=groups[id];
    bin.push(+id);writeU32(bin,blocks.length);
    for(const b of blocks){
      writeCoord(bin,b.x,xB);writeCoord(bin,b.y,yB);writeCoord(bin,b.z,zB);
      bin.push(b.rot,b.dir,b.color);
      if(+id===75)bin.push(b.cpIndex&0xff,0);
      if([65,77].includes(+id))bin.push(0,0);
      if([91,92,93].includes(+id))writeU32(bin,0);
    }
  }
  dbg(`Binary: ${bin.length} bytes, groups: ${Object.keys(groups).map(id=>`ID${id}Ã—${groups[id].length}`).join(', ')}`,'ok');
  return new Uint8Array(bin);
}

async function encodeTrack(linesList,trackName,authorName){
  const trackBin=buildFromLines(linesList);
  const te=new TextEncoder();
  const nameB=te.encode(trackName),authB=te.encode(authorName);
  const prefix=new Uint8Array([nameB.length,...nameB,authB.length,...authB]);
  const full=new Uint8Array(prefix.length+trackBin.length);
  full.set(prefix);full.set(trackBin,prefix.length);
  const c1=await zlibCompress(full);
  const b1=encode62(c1);
  const c2=await zlibCompress(te.encode(b1));
  return 'PolyTrack1'+encode62(c2);
}

function outputCode(code){
  lastGeneratedCode=code;
  document.getElementById('outputCode').textContent=code;
  document.getElementById('statE').textContent=(code.length/1024).toFixed(1)+' KB';
  log(`Done â€” ${code.length} chars`,'ok');
  dbg(`Encoded: ${code.length} chars (${(code.length/1024).toFixed(1)} KB)`,'ok');
}

function copyCode(){
  if(!lastGeneratedCode){toast('Generate a track first');return;}
  navigator.clipboard.writeText(lastGeneratedCode).then(()=>toast('Copied to clipboard!'));
}
function downloadCode(){
  if(!lastGeneratedCode){toast('Generate a track first');return;}
  const name=document.getElementById(currentMode+'TrackName')?.value||'polytrack';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([lastGeneratedCode],{type:'text/plain'}));
  a.download=name+'.txt';a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ KML MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COORD_SCALE=4;

function parseKML(text){
  text=text.replace(/^\uFEFF/,'').replace(/<\?xml[^>]*\?>\s*/i,'');
  const doc=new DOMParser().parseFromString(text,'text/xml');
  const el=doc.querySelector('coordinates')||doc.getElementsByTagNameNS('http://www.opengis.net/kml/2.2','coordinates')[0];
  if(!el)throw new Error('No <coordinates> element found in KML');
  const coords=[];
  for(const pt of el.textContent.trim().split(/\s+/)){
    const p=pt.split(',').map(Number);
    if(p.length>=2&&!p.some(isNaN))coords.push({lon:p[0],lat:p[1],alt:p[2]||0});
  }
  if(coords.length<2)throw new Error('Need at least 2 coordinate points');
  return coords;
}

function haversineM(lon1,lat1,lon2,lat2){
  const R=6371000,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.asin(Math.sqrt(a));
}
function toLocalMeters(coords){
  const o=coords[0];
  return coords.map(c=>({
    x:haversineM(o.lon,o.lat,c.lon,o.lat)*(c.lon>=o.lon?1:-1),
    z:haversineM(o.lon,o.lat,o.lon,c.lat)*(c.lat>=o.lat?1:-1),
    alt:c.alt
  }));
}

function rdp(pts,eps){
  if(pts.length<=2)return pts;
  let maxD=0,maxI=0;
  const s=pts[0],e=pts[pts.length-1],dx=e.x-s.x,dz=e.z-s.z,len=Math.sqrt(dx*dx+dz*dz);
  for(let i=1;i<pts.length-1;i++){
    const d=len===0?Math.sqrt((pts[i].x-s.x)**2+(pts[i].z-s.z)**2)
      :Math.abs(dz*pts[i].x-dx*pts[i].z+e.x*s.z-e.z*s.x)/len;
    if(d>maxD){maxD=d;maxI=i;}
  }
  if(maxD>eps){const L=rdp(pts.slice(0,maxI+1),eps),R=rdp(pts.slice(maxI),eps);return[...L.slice(0,-1),...R];}
  return[s,e];
}

function angleBetween(ax,az,bx,bz){
  const dot=ax*bx+az*bz,la=Math.sqrt(ax*ax+az*az),lb=Math.sqrt(bx*bx+bz*bz);
  if(la===0||lb===0)return 0;
  return Math.acos(Math.max(-1,Math.min(1,dot/(la*lb))))*180/Math.PI;
}

function pathToLines(localPts,originX,originY,originZ,roadWidth,useElevation,turnThreshDeg){
  const BXZ=20,BY=5;
  const bp=localPts.map(p=>({
    bx:(Math.round(p.x/BXZ)+originX)*COORD_SCALE,
    by:useElevation?(Math.round(p.alt/BY)+originY)*COORD_SCALE:originY*COORD_SCALE,
    bz:(Math.round(p.z/BXZ)+originZ)*COORD_SCALE
  }));
  const pts=[bp[0]];
  for(let i=1;i<bp.length;i++){
    const prev=pts[pts.length-1];
    if(bp[i].bx!==prev.bx||bp[i].by!==prev.by||bp[i].bz!==prev.bz)pts.push(bp[i]);
  }
  const halfW=Math.floor(roadWidth/2)*COORD_SCALE;
  const farW=(roadWidth-1-Math.floor(roadWidth/2))*COORD_SCALE;
  const seenRoad=new Set();const roadPoints=[];const checkpointPts=[];
  for(let i=0;i<pts.length-1;i++){
    const a=pts[i],b=pts[i+1];
    const sdx=b.bx-a.bx,sdz=b.bz-a.bz;
    let nx,nz;if(Math.abs(sdx)>=Math.abs(sdz)){nx=0;nz=1;}else{nx=1;nz=0;}
    const center=line3D(a.bx,a.by,a.bz,b.bx,b.by,b.bz);
    for(const cb of center){
      if(roadWidth<=1){
        const key=`${cb.x},${cb.y},${cb.z}`;
        if(!seenRoad.has(key)){seenRoad.add(key);roadPoints.push({x:cb.x,y:cb.y,z:cb.z});}
      } else {
        const wx1=cb.x+nx*(-halfW),wz1=cb.z+nz*(-halfW);
        const wx2=cb.x+nx*farW,wz2=cb.z+nz*farW;
        const slabPts=line3D(wx1,cb.y,wz1,wx2,cb.y,wz2);
        for(const sp of slabPts){
          const key=`${sp.x},${sp.y},${sp.z}`;
          if(!seenRoad.has(key)){seenRoad.add(key);roadPoints.push({x:sp.x,y:sp.y,z:sp.z});}
        }
      }
    }
    if(i<pts.length-2){
      const c=pts[i+2];
      const angle=angleBetween(b.bx-a.bx,b.bz-a.bz,c.bx-b.bx,c.bz-b.bz);
      if(angle>=turnThreshDeg)checkpointPts.push({bx:b.bx,by:b.by,bz:b.bz});
    }
  }
  const outLines=[];
  outLines.push({id:25,points:roadPoints,rot:0});
  checkpointPts.forEach((cp,i)=>outLines.push({id:75,points:[{x:cp.bx,y:cp.by,z:cp.bz,cpIndex:i}],rot:0,cpIndex:i}));
  outLines.push({id:92,points:[{x:pts[0].bx,y:pts[0].by,z:pts[0].bz}],rot:0});
  const last=pts[pts.length-1];
  outLines.push({id:76,points:[{x:last.bx,y:last.by,z:last.bz}],rot:0});
  dbg(`pathToLines: ${pts.length} waypoints, ${roadPoints.length} road, ${checkpointPts.length} checkpoints`);
  return{lines:outLines,blockPts:pts,checkpointPts,roadBlockCount:roadPoints.length};
}

function drawKMLPreview(blockPts,checkpointPts){
  const canvas=document.getElementById('kmlCanvas');
  const ctx=canvas.getContext('2d');
  const W=canvas.offsetWidth||800;
  canvas.width=W;
  ctx.fillStyle='#07090f';ctx.fillRect(0,0,W,canvas.height);
  if(!blockPts||blockPts.length<2)return;
  const xs=blockPts.map(p=>p.bx),zs=blockPts.map(p=>p.bz);
  const minX=Math.min(...xs),maxX=Math.max(...xs),minZ=Math.min(...zs),maxZ=Math.max(...zs);
  const pad=45,rX=maxX-minX||1,rZ=maxZ-minZ||1;
  const scale=Math.min((W-pad*2)/rX,(canvas.height-pad*2)/rZ);
  const toC=(bx,bz)=>({cx:pad+(bx-minX)*scale,cy:pad+(bz-minZ)*scale});
  // Grid
  ctx.fillStyle='rgba(255,255,255,.025)';
  const gs=Math.max(1,Math.round(40/scale));
  for(let gx=0;gx<=rX;gx+=gs)for(let gz=0;gz<=rZ;gz+=gs){const{cx,cy}=toC(minX+gx,minZ+gz);ctx.fillRect(cx,cy,1,1);}
  // Track
  ctx.shadowColor='#f5a623';ctx.shadowBlur=7;
  ctx.strokeStyle='#f5a623';ctx.lineWidth=Math.max(1.5,scale*.8);ctx.lineJoin='round';
  ctx.beginPath();
  const{cx:sx0,cy:sz0}=toC(blockPts[0].bx,blockPts[0].bz);
  ctx.moveTo(sx0,sz0);
  for(let i=1;i<blockPts.length;i++){const{cx,cy}=toC(blockPts[i].bx,blockPts[i].bz);ctx.lineTo(cx,cy);}
  ctx.stroke();ctx.shadowBlur=0;
  // Checkpoints
  if(checkpointPts){
    ctx.fillStyle='rgba(57,200,224,.9)';
    for(const cp of checkpointPts){const{cx,cy}=toC(cp.bx,cp.bz);ctx.beginPath();ctx.arc(cx,cy,3,0,Math.PI*2);ctx.fill();}
  }
  // Start/finish
  const{cx:sc,cy:sy}=toC(blockPts[0].bx,blockPts[0].bz);
  const{cx:fc,cy:fy}=toC(blockPts[blockPts.length-1].bx,blockPts[blockPts.length-1].bz);
  ctx.shadowColor='#39e08c';ctx.shadowBlur=12;ctx.fillStyle='#39e08c';
  ctx.beginPath();ctx.arc(sc,sy,6,0,Math.PI*2);ctx.fill();
  ctx.shadowColor='#e03939';ctx.fillStyle='#e03939';
  ctx.beginPath();ctx.arc(fc,fy,6,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;
  ctx.font='11px "JetBrains Mono",monospace';
  ctx.fillStyle='#39e08c';ctx.fillText('START',sc+10,sy+4);
  ctx.fillStyle='#e03939';ctx.fillText('FINISH',fc+10,fy+4);
  ctx.font='10px "JetBrains Mono",monospace';
  ctx.fillStyle='rgba(57,200,224,.85)';ctx.beginPath();ctx.arc(pad+5,canvas.height-22,4,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.25)';ctx.fillText('CHECKPOINT',pad+14,canvas.height-18);
  document.getElementById('canvasInfo').textContent=
    `${Math.round(rX/COORD_SCALE)}Ã—${Math.round(rZ/COORD_SCALE)} blocks Â· ${(Math.round(rX/COORD_SCALE)*20/1000).toFixed(1)}Ã—${(Math.round(rZ/COORD_SCALE)*20/1000).toFixed(1)} km`;
}

async function generateKML(){
  const btn=document.getElementById('kmlGenBtn');
  btn.disabled=true;btn.textContent='â³ Generatingâ€¦';
  try{
    const kmlText=document.getElementById('kmlInput').value.trim();
    if(!kmlText){log('Paste KML data first','err');return;}
    dbg('=== KML Generate ===');log('Parsing KMLâ€¦','warn');
    const coords=parseKML(kmlText);
    dbg(`KML: ${coords.length} points`);
    let totalDist=0;
    for(let i=1;i<coords.length;i++)totalDist+=haversineM(coords[i-1].lon,coords[i-1].lat,coords[i].lon,coords[i].lat);
    let localPts=toLocalMeters(coords);
    dbg(`Local metres: x=[${Math.min(...localPts.map(p=>p.x)).toFixed(0)}â€¦${Math.max(...localPts.map(p=>p.x)).toFixed(0)}]`);
    if(document.getElementById('smoothPath').checked){
      const tol=parseFloat(document.getElementById('smoothTol').value)||10;
      const before=localPts.length;
      localPts=rdp(localPts,tol);
      dbg(`RDP: ${before} â†’ ${localPts.length} waypoints (tol=${tol}m)`,'warn');
    }
    const originX=parseInt(document.getElementById('originX').value)||500;
    const originY=parseInt(document.getElementById('originY').value)||0;
    const originZ=parseInt(document.getElementById('originZ').value)||500;
    const roadWidth=parseInt(document.getElementById('roadWidth').value)||1;
    const turnThresh=parseFloat(document.getElementById('turnAngle').value)||20;
    const{lines:kmlLines,blockPts,checkpointPts,roadBlockCount}=
      pathToLines(localPts,originX,originY,originZ,roadWidth,false,turnThresh);
    setStats(coords.length,roadBlockCount,checkpointPts.length,(totalDist/1000).toFixed(2)+' km',null);
    drawKMLPreview(blockPts,checkpointPts);
    log('Compressingâ€¦','warn');
    const trackName=document.getElementById('kmlTrackName').value||'My Circuit';
    const authorName=document.getElementById('kmlAuthor').value||'Builder';
    const code=await encodeTrack(kmlLines,trackName,authorName);
    outputCode(code);
    setStats(coords.length,roadBlockCount,checkpointPts.length,(totalDist/1000).toFixed(2)+' km',(code.length/1024).toFixed(1)+' KB');
    toast('Circuit generated!');
  }catch(e){
    dbg('ERROR: '+e.message,'err');log('Error: '+e.message,'err');
  }finally{
    btn.disabled=false;btn.textContent='âš¡ Generate from KML';
  }
}

// File drop
const dz=document.getElementById('dropZone'),fi=document.getElementById('fileInput');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over')});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');if(e.dataTransfer.files[0])readKMLFile(e.dataTransfer.files[0]);});
fi.addEventListener('change',()=>{if(fi.files[0])readKMLFile(fi.files[0]);});
function readKMLFile(f){
  const r=new FileReader();
  r.onload=ev=>{document.getElementById('kmlInput').value=ev.target.result;log(`Loaded: ${f.name}`,'ok');toast(`Loaded ${f.name}`);};
  r.readAsText(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ SHAPE BUILDER MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function line3D(x1,y1,z1,x2,y2,z2){
  const pts=[],dx=x2-x1,dy=y2-y1,dz=z2-z1;
  const ax=Math.abs(dx),ay=Math.abs(dy),az=Math.abs(dz);
  const sx=dx>0?1:-1,sy=dy>0?1:-1,sz=dz>0?1:-1;
  let x=x1,y=y1,z=z1;
  if(ax>=ay&&ax>=az){
    let yd=ay-ax/2,zd=az-ax/2;
    for(;;){pts.push({x,y,z});if(x===x2)return pts;x+=sx;if(yd>=0){y+=sy;yd-=ax;}yd+=ay;if(zd>=0){z+=sz;zd-=ax;}zd+=az;}
  }else if(ay>=ax&&ay>=az){
    let xd=ax-ay/2,zd=az-ay/2;
    for(;;){pts.push({x,y,z});if(y===y2)return pts;y+=sy;if(xd>=0){x+=sx;xd-=ay;}xd+=ax;if(zd>=0){z+=sz;zd-=ay;}zd+=az;}
  }else{
    let xd=ax-az/2,yd=ay-az/2;
    for(;;){pts.push({x,y,z});if(z===z2)return pts;z+=sz;if(xd>=0){x+=sx;xd-=az;}xd+=ax;if(yd>=0){y+=sy;yd-=az;}yd+=ay;}
  }
}

function addShape(){
  const type=document.getElementById('shapeType').value;
  if(type==='line'){
    const id=+document.getElementById('lineId').value;
    lines.push({id,points:line3D(+document.getElementById('lsx').value,+document.getElementById('lsy').value,+document.getElementById('lsz').value,+document.getElementById('lex').value,+document.getElementById('ley').value,+document.getElementById('lez').value),rot:+document.getElementById('lineRot').value});
  }else if(type==='filledRect'){
    const plane=document.getElementById('rectPlane').value;
    const fixed=+document.getElementById('fixedCoord').value;
    let mn1=+document.getElementById('rectMin1').value,mx1=+document.getElementById('rectMax1').value;
    let mn2=+document.getElementById('rectMin2').value,mx2=+document.getElementById('rectMax2').value;
    const id=+document.getElementById('rectId').value,rot=+document.getElementById('rectRot').value;
    if(mn1>mx1)[mn1,mx1]=[mx1,mn1];if(mn2>mx2)[mn2,mx2]=[mx2,mn2];
    if(plane==='xz')for(let z=mn2;z<=mx2;z++)lines.push({id,points:line3D(mn1,fixed,z,mx1,fixed,z),rot});
    else if(plane==='xy')for(let y=mn2;y<=mx2;y++)lines.push({id,points:line3D(mn1,y,fixed,mx1,y,fixed),rot});
    else for(let z=mn2;z<=mx2;z++)lines.push({id,points:line3D(fixed,mn1,z,fixed,mx1,z),rot});
  }else if(type==='hollowCube'){
    let[mnX,mnY,mnZ]=[+document.getElementById('hcMinX').value,+document.getElementById('hcMinY').value,+document.getElementById('hcMinZ').value];
    let[mxX,mxY,mxZ]=[+document.getElementById('hcMaxX').value,+document.getElementById('hcMaxY').value,+document.getElementById('hcMaxZ').value];
    if(mnX>mxX)[mnX,mxX]=[mxX,mnX];if(mnY>mxY)[mnY,mxY]=[mxY,mnY];if(mnZ>mxZ)[mnZ,mxZ]=[mxZ,mnZ];
    const id=+document.getElementById('hcId').value,rot=+document.getElementById('hcRot').value;
    for(let z=mnZ;z<=mxZ;z++){lines.push({id,points:line3D(mnX,mnY,z,mxX,mnY,z),rot});lines.push({id,points:line3D(mnX,mxY,z,mxX,mxY,z),rot});}
    for(let y=mnY;y<=mxY;y++){lines.push({id,points:line3D(mnX,y,mnZ,mxX,y,mnZ),rot});lines.push({id,points:line3D(mnX,y,mxZ,mxX,y,mxZ),rot});}
    for(let z=mnZ;z<=mxZ;z++){lines.push({id,points:line3D(mnX,mnY,z,mnX,mxY,z),rot});lines.push({id,points:line3D(mxX,mnY,z,mxX,mxY,z),rot});}
  }else if(type==='filledCube'){
    let[mnX,mnY,mnZ]=[+document.getElementById('fcMinX').value,+document.getElementById('fcMinY').value,+document.getElementById('fcMinZ').value];
    let[mxX,mxY,mxZ]=[+document.getElementById('fcMaxX').value,+document.getElementById('fcMaxY').value,+document.getElementById('fcMaxZ').value];
    if(mnX>mxX)[mnX,mxX]=[mxX,mnX];if(mnY>mxY)[mnY,mxY]=[mxY,mnY];if(mnZ>mxZ)[mnZ,mxZ]=[mxZ,mnZ];
    const id=+document.getElementById('fcId').value,rot=+document.getElementById('fcRot').value;
    for(let y=mnY;y<=mxY;y++)for(let z=mnZ;z<=mxZ;z++)lines.push({id,points:line3D(mnX,y,z,mxX,y,z),rot});
  }
  updateShapeUI();toast(`Shape added â€” ${lines.length} line${lines.length!==1?'s':''}`);
}

function clearLines(){lines=[];updateShapeUI();toast('All lines cleared');}
function removeLine(idx){lines.splice(idx,1);updateShapeUI();}

function updateShapeUI(){
  const list=document.getElementById('linesList');
  const totalBlocks=lines.reduce((s,l)=>s+l.points.length,0);
  const ids=new Set(lines.map(l=>l.id));
  document.getElementById('linesCountLabel').textContent=`${lines.length} lines Â· ${totalBlocks.toLocaleString()} blocks`;
  if(currentMode==='shape')setStats(lines.length,totalBlocks,ids.size,'â€”',null);
  if(lines.length===0){
    list.innerHTML='<div class="empty-state"><div class="empty-icon">â—ˆ</div><p>No shapes added yet.</p></div>';
    return;
  }
  list.innerHTML=lines.map((l,i)=>`
    <div class="line-item">
      <div class="line-badge">ID ${l.id}</div>
      <div class="line-info">
        ${ID_NAMES[l.id]?`<div class="line-name">${ID_NAMES[l.id]}</div>`:''}
        <div>${l.points.length} block${l.points.length!==1?'s':''}</div>
        <div class="line-coords">(${l.points[0].x},${l.points[0].y},${l.points[0].z})â†’(${l.points[l.points.length-1].x},${l.points[l.points.length-1].y},${l.points[l.points.length-1].z})</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="removeLine(${i})">âœ•</button>
    </div>
  `).join('');
}

async function generateShape(){
  if(lines.length===0){toast('Add some shapes first');return;}
  const name=document.getElementById('shapeTrackName').value||'My Track';
  const author=document.getElementById('shapeAuthor').value||'Builder';
  dbg('=== Shape Generate ===');log('Compressingâ€¦','warn');
  try{
    const code=await encodeTrack(lines,name,author);
    outputCode(code);
    const total=lines.reduce((s,l)=>s+l.points.length,0);
    setStats(lines.length,total,new Set(lines.map(l=>l.id)).size,'â€”',(code.length/1024).toFixed(1)+' KB');
    toast('Track generated!');
  }catch(e){dbg('ERROR: '+e.message,'err');log('Error: '+e.message,'err');}
}

function generateTestTrack(){
  lines=[];
  const minId=+document.getElementById('minId').value,maxId=+document.getElementById('maxId').value;
  lines.push({id:92,points:line3D(0,0,0,0,0,0),rot:0});
  let pos=0;
  for(let i=minId;i<=maxId;i++){pos+=20;lines.push({id:i,points:line3D(pos,0,0,pos,0,0),rot:0});}
  lines.push({id:76,points:line3D(pos+20,0,0,pos+20,0,0),rot:0});
  updateShapeUI();toast(`ID test track: IDs ${minId}â€“${maxId}`);
}

function downloadLinesJSON(){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(lines,null,2)],{type:'application/json'}));
  a.download='lines.json';a.click();
}

// Shape form UI
document.getElementById('shapeType').addEventListener('change',()=>{
  document.querySelectorAll('.shape-form').forEach(f=>f.style.display='none');
  document.getElementById('form-'+document.getElementById('shapeType').value).style.display='';
  if(document.getElementById('shapeType').value==='filledRect')updateRectLabels();
});
document.getElementById('rectPlane').addEventListener('change',updateRectLabels);
function updateRectLabels(){
  const p=document.getElementById('rectPlane').value;
  const m={xz:['Fixed Y','Min X','Max X','Min Z','Max Z'],xy:['Fixed Z','Min X','Max X','Min Y','Max Y'],yz:['Fixed X','Min Y','Max Y','Min Z','Max Z']};
  const[fl,m1,x1,m2,x2]=m[p];
  document.getElementById('fixedLabel').textContent=fl;
  document.getElementById('min1Label').textContent=m1;document.getElementById('max1Label').textContent=x1;
  document.getElementById('min2Label').textContent=m2;document.getElementById('max2Label').textContent=x2;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ PIXEL ART MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pCanvas=document.getElementById('previewCanvas');
const pctx=pCanvas.getContext('2d');

function processUpload(){
  const file=document.getElementById('imgUpload').files[0];
  if(!file){toast('Choose an image first');return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const res=Math.max(8,Math.min(512,+document.getElementById('resValue').value||128));
      const preserve=document.getElementById('preserveAspect').checked;
      let tw,th;
      if(preserve){if(img.width<=img.height){tw=res;th=Math.round(img.height*(res/img.width));}else{th=res;tw=Math.round(img.width*(res/img.height));}}
      else{tw=th=res;}
      tw=Math.max(2,Math.min(512,tw));th=Math.max(2,Math.min(512,th));
      const off=document.createElement('canvas');off.width=tw;off.height=th;
      const octx=off.getContext('2d');octx.imageSmoothingEnabled=true;octx.drawImage(img,0,0,tw,th);
      const id=octx.getImageData(0,0,tw,th);
      const lumArr=new Float32Array(tw*th);
      for(let i=0;i<tw*th;i++){
        const r=id.data[i*4],g=id.data[i*4+1],b=id.data[i*4+2],a=id.data[i*4+3];
        const al=a/255,rr=r*al+255*(1-al),gg=g*al+255*(1-al),bb=b*al+255*(1-al);
        lumArr[i]=0.2126*rr+0.7152*gg+0.0722*bb;
      }
      const sorted=Float32Array.from(lumArr).sort();
      const q=p=>sorted[Math.floor(p*(sorted.length-1))];
      const t1=q(.25),t2=q(.5),t3=q(.75);
      const pixels=[];
      for(let y=0;y<th;y++){
        const row=[];
        for(let x=0;x<tw;x++){
          const i=y*tw+x,lum=lumArr[i];
          row.push({bin:lum<=t1?0:lum<=t2?1:lum<=t3?2:3});
        }
        pixels.push(row);
      }
      previewPixels={w:tw,h:th,pixels};
      let s=`${tw},${th}`;const step=Math.max(1,Math.floor(tw*th/256));let cnt=0;
      for(let y=0;y<th;y+=step){for(let x=0;x<tw;x+=step){s+='|'+pixels[y][x].bin;if(++cnt>256)break;}if(cnt>256)break;}
      lastSeed=fnv1a(s);
      drawPixelPreview();updatePixelStats();
      toast(`Preview ready: ${tw}Ã—${th}`);
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

function drawPixelPreview(){
  if(!previewPixels){pctx.clearRect(0,0,310,310);return;}
  const{w,h,pixels}=previewPixels;
  const scale=Math.min(310/w,310/h);
  const pw=Math.floor(scale*w),ph=Math.floor(scale*h);
  pctx.fillStyle='#07090f';pctx.fillRect(0,0,310,310);
  const COLORS=['#3060ff','#b02020','#b09010','#ccd0ee'];
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    pctx.fillStyle=COLORS[pixels[y][x].bin];
    pctx.fillRect(Math.round(x*scale+(310-pw)/2),Math.round(y*scale+(310-ph)/2),Math.ceil(scale),Math.ceil(scale));
  }
}

function fnv1a(str){let h=0x811c9dc5>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,0x01000193)>>>0;}return h>>>0;}
function mulberry32(a){return()=>{let t=(a+=0x6D2B79F5)>>>0;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;};}

function mapBinToId(bin,rng){
  const ids=[+document.getElementById('idBin0').value||5,+document.getElementById('idBin1').value||6,+document.getElementById('idBin2').value||52,+document.getElementById('idBin3').value||0];
  const id=ids[bin];if(id!==0)return id;
  const excl=new Set(ids.filter(v=>v>0&&v<=52));
  const valid=[];for(let i=1;i<=52;i++)if(!excl.has(i))valid.push(i);
  return valid.length?valid[Math.floor(rng()*valid.length)]:1;
}

function updatePixelStats(){
  if(!previewPixels)return;
  const{w,h,pixels}=previewPixels;
  const idSet=new Set();const rng=mulberry32(lastSeed);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++)idSet.add(mapBinToId(pixels[y][x].bin,rng));
  document.getElementById('pixCount').textContent=w*h;
  document.getElementById('uniqueIDs').textContent=idSet.size;
  if(currentMode==='pixel')setStats(w*h,idSet.size,'â€”','â€”',null);
}

function buildPixelLines(){
  if(!previewPixels)return null;
  const spacing=+document.getElementById('pixelSpacing').value||1;
  const use4x=document.getElementById('use4x').checked;const bs=use4x?4:1;
  const ox=+document.getElementById('offsetX').value||0;
  const oy=+document.getElementById('offsetY').value||0;
  const oz=+document.getElementById('offsetZ').value||0;
  const seed=(lastSeed^fnv1a(''+spacing+','+ox+','+oy+','+oz+','+use4x))>>>0;
  const rng=mulberry32(seed);
  const{w,h,pixels}=previewPixels;
  const pxLines=[];
  for(let py=0;py<h;py++)for(let px=0;px<w;px++){
    const id=mapBinToId(pixels[py][px].bin,rng);
    const mx=ox+px*spacing*bs,mz=oz+py*spacing*bs;
    for(let z=mz;z<mz+bs;z++)pxLines.push({id,points:line3D(mx,oy,z,mx+(bs-1),oy,z),rot:0});
  }
  return pxLines;
}

function addPixelToLines(){
  if(!previewPixels){toast('Process an image first');return;}
  const pxLines=buildPixelLines();
  lines.push(...pxLines);
  updateShapeUI();
  switchMode('shape');
  toast(`Added ${pxLines.length} pixel lines to shapes`);
}

async function generatePixel(){
  if(!previewPixels){toast('Process an image first');return;}
  const pxLines=buildPixelLines();
  if(!pxLines||!pxLines.length){toast('No pixel data');return;}
  const name=document.getElementById('pixelTrackName').value||'Pixel Art';
  const author=document.getElementById('pixelAuthor').value||'Builder';
  dbg('=== Pixel Generate ===');log('Compressingâ€¦','warn');
  try{
    const code=await encodeTrack(pxLines,name,author);
    outputCode(code);
    const{w,h}=previewPixels;
    setStats(w*h,pxLines.length,'â€”','â€”',(code.length/1024).toFixed(1)+' KB');
    toast('Pixel art track generated!');
  }catch(e){dbg('ERROR: '+e.message,'err');log('Error: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
switchMode('kml');
</script>

</body>
</html>
